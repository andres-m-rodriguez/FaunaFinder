@page "/species"
@using BlazingSingularity.Commands
@inject ISpeciesRepository SpeciesRepository
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@L["PageTitle_Species"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@L["Species_Title"]</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        @L["Species_Description"]
    </MudText>

    <MudTextField @bind-Value="searchTerm"
                  Placeholder="@L["Species_SearchPlaceholder"]"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="OnSearchChanged"
                  Class="mb-4" />

    @if (LoadSpeciesCommand.IsLoading)
    {
        <MudContainer Class="d-flex justify-center py-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </MudContainer>
    }
    else if (species.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
            @L["Species_NoResults"]
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var s in species)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="2" Class="species-card" @onclick="() => NavigateToSpecies(s.Id)">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary">@s.CommonName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="font-italic">
                                @s.ScientificName
                            </MudText>
                            <div class="d-flex align-center mt-2">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Secondary" Class="mr-2" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @s.MunicipalityNames.Count @(s.MunicipalityNames.Count == 1 ? L["Species_Municipality"] : L["Species_Municipalities"])
                                </MudText>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <div class="d-flex justify-center mt-6">
            <MudPagination Count="@totalPages"
                          Selected="@(currentPage + 1)"
                          SelectedChanged="OnPageChanged"
                          Color="Color.Primary"
                          Variant="Variant.Filled"
                          ShowFirstButton="true"
                          ShowLastButton="true" />
        </div>

        <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center" Class="mt-2">
            @L["Species_Showing", (currentPage * pageSize) + 1, Math.Min((currentPage + 1) * pageSize, totalCount), totalCount]
        </MudText>
    }
</MudContainer>

<style>
    .species-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        height: 100%;
        cursor: pointer;
    }

    .species-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }
</style>

@code {
    private IReadOnlyList<SpeciesForSearchDto> species = [];
    private string searchTerm = string.Empty;
    private int currentPage = 0;
    private int pageSize = 12;
    private int totalCount = 0;
    private int totalPages = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadSpeciesCommand.ExecuteAsync();
    }

    [RelayCommand]
    private async Task LoadSpecies()
    {
        var parameters = new SpeciesParameters(
            PageSize: pageSize,
            Page: currentPage,
            Search: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
        );

        species = await SpeciesRepository.GetSpeciesAsync(parameters);
        totalCount = await SpeciesRepository.GetTotalSpeciesCountAsync(
            string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
        );
        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    }

    private async Task OnSearchChanged()
    {
        currentPage = 0;
        await LoadSpeciesCommand.ExecuteAsync();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page - 1;
        await LoadSpeciesCommand.ExecuteAsync();
    }

    private void NavigateToSpecies(int speciesId)
    {
        NavigationManager.NavigateTo($"/species/{speciesId}?returnUrl=/species");
    }
}
