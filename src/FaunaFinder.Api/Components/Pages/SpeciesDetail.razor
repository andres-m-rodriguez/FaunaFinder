@page "/species/{Id:int}"
@using BlazingSingularity.Commands
@inject ISpeciesRepository SpeciesRepository
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@(species != null ? L.GetSpeciesName(species.CommonName, species.Translations) : L["Nav_Species"]) - FaunaFinder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @* Back Navigation *@
    <MudButton Variant="Variant.Text"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.ArrowBack"
               OnClick="NavigateBack"
               Class="mb-4">
        @L["Back"]
    </MudButton>

    @if (LoadDataCommand.IsLoading)
    {
        <MudContainer Class="d-flex justify-center py-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </MudContainer>
    }
    else if (species == null)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
            @L["Error_SpeciesNotFound"]
        </MudAlert>
    }
    else
    {
        @* Species Header *@
        <MudPaper Elevation="2" Class="pa-4 mb-6">
            <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@L.GetSpeciesName(species.CommonName, species.Translations)</MudText>
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="font-italic">@species.ScientificName</MudText>
            <div class="d-flex align-center mt-3">
                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Medium" Color="Color.Secondary" Class="mr-2" />
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    @L["SpeciesDetail_FoundIn", species.Municipalities.Count, species.Municipalities.Count == 1 ? L["Species_Municipality"] : L["Species_Municipalities"]]
                </MudText>
            </div>
            @if (species.Locations.Count > 0)
            {
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Map"
                           OnClick="ViewLocations"
                           Class="mt-4">
                    @L["SpeciesDetail_ViewLocations"]
                </MudButton>
            }
        </MudPaper>

        @* Municipalities Section *@
        <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true" Class="mb-4">@L["SpeciesDetail_MunicipalitiesTitle"]</MudText>

        @if (species.Municipalities.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-6">
                @L["SpeciesDetail_NoMunicipalityData"]
            </MudAlert>
        }
        else
        {
            <MudGrid Spacing="3" Class="mb-6">
                @foreach (var municipality in species.Municipalities)
                {
                    <MudItem xs="6" sm="4" md="3">
                        <MudCard Elevation="2" Class="municipality-card" @onclick="() => NavigateToMunicipality(municipality.Id)">
                            <MudCardContent Class="d-flex align-center justify-center pa-3">
                                <MudIcon Icon="@Icons.Material.Filled.LocationCity" Size="Size.Small" Color="Color.Primary" Class="mr-2" />
                                <MudText Typo="Typo.body1" Color="Color.Primary">@municipality.Name</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }

        @* Conservation Links Section *@
        <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true" Class="mb-4">@L["SpeciesDetail_ConservationLinksTitle"]</MudText>

        @if (species.FwsLinks.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
                @L["SpeciesDetail_NoConservationLinks"]
            </MudAlert>
        }
        else
        {
            <MudGrid Spacing="3">
                @foreach (var link in species.FwsLinks)
                {
                    <MudItem xs="12" md="6">
                        <MudPaper Elevation="1" Class="pa-4">
                            <div class="d-flex flex-wrap align-start gap-2 mb-2">
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                    NRCS @link.NrcsPractice.Code
                                </MudChip>
                                <MudText Typo="Typo.body1">@link.NrcsPractice.Name</MudText>
                            </div>
                            <div class="d-flex flex-wrap align-start gap-2 mb-2">
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">
                                    FWS @link.FwsAction.Code
                                </MudChip>
                                <MudText Typo="Typo.body1">@link.FwsAction.Name</MudText>
                            </div>
                            @if (!string.IsNullOrEmpty(link.Justification))
                            {
                                <MudDivider Class="my-3" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @link.Justification
                                </MudText>
                            }
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        }
    }
</MudContainer>

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private SpeciesForDetailDto? species;

    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataCommand.ExecuteAsync();
    }
    [RelayCommand]
    private async Task LoadData()
    {
        species = await SpeciesRepository.GetSpeciesDetailAsync(Id);
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo(string.IsNullOrEmpty(ReturnUrl) ? "/species" : ReturnUrl);
    }

    private void NavigateToMunicipality(int municipalityId)
    {
        NavigationManager.NavigateTo($"/pueblos/{municipalityId}?returnUrl=/species/{Id}");
    }

    private void ViewLocations()
    {
        NavigationManager.NavigateTo($"/?speciesId={Id}");
    }
}
