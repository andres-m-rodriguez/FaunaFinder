@page "/"
@using BlazingSingularity.Commands
@using FaunaFinder.Api.Services.Export
@inject IMunicipalityRepository MunicipalityRepository
@inject ISpeciesRepository SpeciesRepository
@inject IMunicipalityReportService ReportService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject IAppLocalizer L
@inject ISnackbar Snackbar

<PageTitle>@L["PageTitle_Map"]</PageTitle>

<div class="map-page">
    <div class="map-container">
        <div id="map" class="map"></div>
    </div>

    @* Desktop Sidebar *@
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <div class="desktop-sidebar @(sidebarOpen ? "open" : "")">
            @if (LoadMunicipalitySpeciesCommand.IsLoading || LoadAllSpeciesCommand.IsLoading)
            {
                <SidebarHeader Title="@(clickedMunicipalityName ?? L["AllSpecies"])" OnClose="CloseSidebar" />
                <LoadingPanel Message="@L["Loading"]" />
            }
            else if (clickedMunicipalityName != null)
            {
                <SidebarHeader Title="@clickedMunicipalityName" OnClose="CloseSidebar" />

                @* Filter/Sort Toolbar *@
                @if (species.Count > 0)
                {
                    <MudPaper Class="px-3 py-2" Square="true" Elevation="0">
                        <div class="d-flex align-center gap-2 flex-wrap">
                            <MudSelect T="SortOption" Value="currentSort" ValueChanged="OnSortChanged"
                                       Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                                       Style="max-width: 150px;" Label="@L["Filter_Sort"]">
                                <MudSelectItem Value="SortOption.NameAZ">@L["Filter_NameAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.NameZA">@L["Filter_NameZA"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificAZ">@L["Filter_ScientificAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificZA">@L["Filter_ScientificZA"]</MudSelectItem>
                            </MudSelect>

                            <MudMenu Icon="@Icons.Material.Filled.FilterList" Size="Size.Small" Dense="true"
                                     AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                                <MudMenuItem OnClick="OpenFilterDialog">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Tune" Size="Size.Small" />
                                        <span>@L["Filter_Filters"]</span>
                                        @if (ActiveFilterCount > 0)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@ActiveFilterCount</MudChip>
                                        }
                                    </div>
                                </MudMenuItem>
                                @if (ActiveFilterCount > 0)
                                {
                                    <MudMenuItem OnClick="ClearAllFilters">
                                        <div class="d-flex align-center gap-2">
                                            <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" />
                                            <span>@L["Filter_ClearAll"]</span>
                                        </div>
                                    </MudMenuItem>
                                }
                            </MudMenu>

                            <MudMenu Icon="@Icons.Material.Filled.Download" Size="Size.Small" Dense="true"
                                     AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft"
                                     Disabled="isExporting">
                                <MudMenuItem OnClick="ExportToPdf">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.PictureAsPdf" Size="Size.Small" />
                                        <span>@L["Export_PDF"]</span>
                                    </div>
                                </MudMenuItem>
                                <MudMenuItem OnClick="ExportToCsv">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Size="Size.Small" />
                                        <span>@L["Export_CSV"]</span>
                                    </div>
                                </MudMenuItem>
                            </MudMenu>
                        </div>

                        @* Active filter chips *@
                        @if (ActiveFilterCount > 0)
                        {
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                @foreach (var practice in selectedNrcsPractices)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" OnClose="() => RemoveNrcsPracticeFilter(practice)">
                                        NRCS @practice
                                    </MudChip>
                                }
                                @foreach (var action in selectedFwsActions)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" OnClose="() => RemoveFwsActionFilter(action)">
                                        FWS @action
                                    </MudChip>
                                }
                            </div>
                        }
                    </MudPaper>
                }

                <div class="sidebar-content">
                    @if (species.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                            @L["Map_NoSpeciesData"]
                        </MudAlert>
                    }
                    else
                    {
                        <div class="pa-3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @if (ActiveFilterCount > 0)
                                {
                                    @string.Format(L["Filter_ShowingFiltered"], FilteredSpecies.Count, species.Count)
                                }
                                else
                                {
                                    @string.Format(L["Map_SpeciesFound"], species.Count)
                                }
                            </MudText>

                            @if (FilteredSpecies.Count == 0)
                            {
                                <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-2">
                                    @L["Filter_NoMatches"]
                                </MudAlert>
                            }

                            <MudExpansionPanels MultiExpansion="false" Elevation="0">
                                @foreach (var s in FilteredSpecies)
                                {
                                    <SpeciesExpansionPanel Species="s"
                                                           IsExpanded="@(expandedSpeciesId == s.Id)"
                                                           OnExpandedChanged="@((bool expanded) => ToggleSpecies(s.Id, expanded))" />
                                }
                            </MudExpansionPanels>
                        </div>
                    }
                </div>
            }
            else if (showAllSpecies)
            {
                <SidebarHeader Title="@L["AllSpecies"]" OnClose="CloseSidebar" />

                <div class="sidebar-content pa-3">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                        @string.Format(L["Map_SpeciesInDatabase"], allSpecies.Count)
                    </MudText>

                    <MudList T="string" Dense="true">
                        @foreach (var s in allSpecies)
                        {
                            <SpeciesListItem CommonName="s.CommonName"
                                             ScientificName="s.ScientificName"
                                             ShowDetailsButton="true"
                                             OnDetailsClick="@(() => NavigateToSpeciesDetail(s.Id))" />
                        }
                    </MudList>
                </div>
            }
            else if (showNearbySpecies)
            {
                <SidebarHeader Title="@L["NearMe_Title"]"
                               Icon="@Icons.Material.Filled.NearMe"
                               ThemeClass="mud-theme-info"
                               OnClose="CloseSpeciesNearMe" />

                <MudPaper Class="px-3 py-2" Square="true" Elevation="0">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">@L["NearMe_SelectRadius"]</MudText>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @foreach (var radius in RadiusOptions)
                        {
                            <MudChip T="string"
                                     Color="@(selectedRadiusKm == radius ? Color.Info : Color.Default)"
                                     Variant="@(selectedRadiusKm == radius ? Variant.Filled : Variant.Outlined)"
                                     OnClick="() => OnRadiusChanged(radius)"
                                     Size="Size.Small">
                                @($"{radius} km")
                            </MudChip>
                        }
                    </div>
                    @if (nearbySpecies.Count > 0)
                    {
                        <MudButton Variant="@(showSpeciesLocationsOnMap ? Variant.Filled : Variant.Outlined)"
                                   Color="Color.Info"
                                   Size="Size.Small"
                                   StartIcon="@(showSpeciesLocationsOnMap ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                   OnClick="ToggleSpeciesLocationsOnMap"
                                   FullWidth="true">
                            @(showSpeciesLocationsOnMap ? L["NearMe_HideLocations"] : L["NearMe_ShowLocations"])
                        </MudButton>
                    }
                </MudPaper>

                <div class="sidebar-content">
                    @if (isLoadingNearbySpecies)
                    {
                        <LoadingPanel Message="@L["NearMe_Searching"]" Color="Color.Info" />
                    }
                    else if (nearbySpecies.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                            @L["NearMe_NoSpeciesFound"]
                        </MudAlert>
                    }
                    else
                    {
                        <div class="pa-3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @string.Format(L["NearMe_SpeciesFound"], nearbySpecies.Count, selectedRadiusKm)
                            </MudText>

                            <MudList T="SpeciesNearbyDto" Dense="true" Class="nearby-species-list">
                                @for (var i = 0; i < nearbySpecies.Count; i++)
                                {
                                    var index = i;
                                    var s = nearbySpecies[i];
                                    <NearbySpeciesListItem Species="s"
                                                           ShowColorDot="showSpeciesLocationsOnMap"
                                                           Color="@(speciesColors.TryGetValue(s.Id, out var color) ? color : null)"
                                                           OnClick="() => FocusOnNearbySpecies(index)"
                                                           OnDetailsClick="() => NavigateToSpeciesDetail(s.Id)" />
                                }
                            </MudList>
                        </div>
                    }
                </div>
            }
            else
            {
                <MudPaper Class="pa-3 mud-theme-primary" Square="true" Elevation="0">
                    <MudText Typo="Typo.subtitle1">@L["AppTitle"]</MudText>
                </MudPaper>

                <div class="pa-4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        @L["Map_ClickMunicipality"]
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Class="mb-2"
                               OnClick="@(() => LoadAllSpeciesCommand.ExecuteAsync(CancellationToken.None))">
                        @L["ViewAllSpecies"]
                    </MudButton>
                    @if (userLatitude.HasValue && userLongitude.HasValue)
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Info"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.NearMe"
                                   OnClick="OpenSpeciesNearMe">
                            @L["NearMe_Button"]
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-2">
                            @L["NearMe_UseLocateFirst"]
                        </MudAlert>
                    }
                </div>
            }
        </div>
    </MudHidden>

    @* Mobile Bottom Sheet *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        @if (clickedMunicipalityName != null || showAllSpecies || showNearbySpecies)
        {
            <div class="mobile-sheet-backdrop @(sheetOpen ? "open" : "")" @onclick="CloseSheet"></div>
            <div class="mobile-sheet @(sheetOpen ? "open" : "")">
                <div class="mobile-sheet-header">
                    <MudText Typo="Typo.subtitle1" Class="ml-3">
                        @(showNearbySpecies ? L["NearMe_Title"] : (clickedMunicipalityName ?? L["AllSpecies"]))
                    </MudText>
                    <MudSpacer />
                    @if (clickedMunicipalityName != null && species.Count > 0)
                    {
                        <MudMenu Icon="@Icons.Material.Filled.Download"
                                 Size="Size.Small"
                                 Dense="true"
                                 AnchorOrigin="Origin.BottomLeft"
                                 TransformOrigin="Origin.TopRight"
                                 Disabled="isExporting">
                            <MudMenuItem OnClick="ExportToPdf">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.PictureAsPdf" Size="Size.Small" />
                                    <span>@L["Export_PDF"]</span>
                                </div>
                            </MudMenuItem>
                            <MudMenuItem OnClick="ExportToCsv">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.TableChart" Size="Size.Small" />
                                    <span>@L["Export_CSV"]</span>
                                </div>
                            </MudMenuItem>
                        </MudMenu>
                        <MudIconButton Icon="@Icons.Material.Filled.FilterList"
                                       Size="Size.Small"
                                       OnClick="OpenFilterDialog"
                                       Color="@(ActiveFilterCount > 0 ? Color.Primary : Color.Default)" />
                    }
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Size="Size.Medium"
                                   OnClick="CloseSheet" />
                </div>

                @* Mobile Sort/Filter Bar *@
                @if (clickedMunicipalityName != null && species.Count > 0)
                {
                    <div class="px-3 py-2">
                        <div class="d-flex align-center gap-2">
                            <MudSelect T="SortOption" Value="currentSort" ValueChanged="OnSortChanged"
                                       Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                                       Style="flex: 1;" Label="@L["Filter_Sort"]">
                                <MudSelectItem Value="SortOption.NameAZ">@L["Filter_NameAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.NameZA">@L["Filter_NameZA"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificAZ">@L["Filter_ScientificAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificZA">@L["Filter_ScientificZA"]</MudSelectItem>
                            </MudSelect>
                            @if (ActiveFilterCount > 0)
                            {
                                <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="ClearAllFilters">
                                    @L["Filter_ClearAll"]
                                </MudButton>
                            }
                        </div>

                        @if (ActiveFilterCount > 0)
                        {
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                @foreach (var practice in selectedNrcsPractices)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" OnClose="() => RemoveNrcsPracticeFilter(practice)">
                                        NRCS @practice
                                    </MudChip>
                                }
                                @foreach (var action in selectedFwsActions)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" OnClose="() => RemoveFwsActionFilter(action)">
                                        FWS @action
                                    </MudChip>
                                }
                            </div>
                        }
                    </div>
                }

                @if (LoadMunicipalitySpeciesCommand.IsLoading || LoadAllSpeciesCommand.IsLoading)
                {
                    <LoadingPanel Message="@L["Loading"]" />
                }
                else if (clickedMunicipalityName != null)
                {
                    <MudContainer Class="pa-3" MaxWidth="MaxWidth.False">
                        @if (species.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Text">
                                @L["Map_NoSpeciesData"]
                            </MudAlert>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @if (ActiveFilterCount > 0)
                                {
                                    @string.Format(L["Filter_ShowingFiltered"], FilteredSpecies.Count, species.Count)
                                }
                                else
                                {
                                    @string.Format(L["Map_SpeciesFound"], species.Count)
                                }
                            </MudText>

                            @if (FilteredSpecies.Count == 0)
                            {
                                <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-2">
                                    @L["Filter_NoMatches"]
                                </MudAlert>
                            }

                            <MudExpansionPanels MultiExpansion="false" Elevation="0">
                                @foreach (var s in FilteredSpecies)
                                {
                                    <SpeciesExpansionPanel Species="s"
                                                           IsExpanded="@(expandedSpeciesId == s.Id)"
                                                           OnExpandedChanged="@((bool expanded) => ToggleSpecies(s.Id, expanded))" />
                                }
                            </MudExpansionPanels>
                        }
                    </MudContainer>
                }
                else if (showAllSpecies)
                {
                    <MudContainer Class="pa-3" MaxWidth="MaxWidth.False">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                            @string.Format(L["Map_SpeciesInDatabase"], allSpecies.Count)
                        </MudText>

                        <MudList T="string" Dense="true">
                            @foreach (var s in allSpecies)
                            {
                                <SpeciesListItem CommonName="s.CommonName"
                                                 ScientificName="s.ScientificName"
                                                 ShowDetailsButton="true"
                                                 OnDetailsClick="@(() => NavigateToSpeciesDetail(s.Id))" />
                            }
                        </MudList>
                    </MudContainer>
                }
                else if (showNearbySpecies)
                {
                    <div class="px-3 py-2">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">@L["NearMe_SelectRadius"]</MudText>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @foreach (var radius in RadiusOptions)
                            {
                                <MudChip T="string"
                                         Color="@(selectedRadiusKm == radius ? Color.Info : Color.Default)"
                                         Variant="@(selectedRadiusKm == radius ? Variant.Filled : Variant.Outlined)"
                                         OnClick="() => OnRadiusChanged(radius)"
                                         Size="Size.Small">
                                    @($"{radius} km")
                                </MudChip>
                            }
                        </div>
                        @if (nearbySpecies.Count > 0)
                        {
                            <MudButton Variant="@(showSpeciesLocationsOnMap ? Variant.Filled : Variant.Outlined)"
                                       Color="Color.Info"
                                       Size="Size.Small"
                                       StartIcon="@(showSpeciesLocationsOnMap ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                       OnClick="ToggleSpeciesLocationsOnMap"
                                       FullWidth="true">
                                @(showSpeciesLocationsOnMap ? L["NearMe_HideLocations"] : L["NearMe_ShowLocations"])
                            </MudButton>
                        }
                    </div>

                    @if (isLoadingNearbySpecies)
                    {
                        <LoadingPanel Message="@L["NearMe_Searching"]" Color="Color.Info" />
                    }
                    else if (nearbySpecies.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                            @L["NearMe_NoSpeciesFound"]
                        </MudAlert>
                    }
                    else
                    {
                        <MudContainer Class="pa-3" MaxWidth="MaxWidth.False">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @string.Format(L["NearMe_SpeciesFound"], nearbySpecies.Count, selectedRadiusKm)
                            </MudText>

                            <MudList T="SpeciesNearbyDto" Dense="true" Class="nearby-species-list">
                                @for (var i = 0; i < nearbySpecies.Count; i++)
                                {
                                    var index = i;
                                    var s = nearbySpecies[i];
                                    <NearbySpeciesListItem Species="s"
                                                           ShowColorDot="showSpeciesLocationsOnMap"
                                                           Color="@(speciesColors.TryGetValue(s.Id, out var mobileColor) ? mobileColor : null)"
                                                           OnClick="() => FocusOnNearbySpecies(index)"
                                                           OnDetailsClick="() => NavigateToSpeciesDetail(s.Id)" />
                                }
                            </MudList>
                        </MudContainer>
                    }
                }
            </div>
        }
    </MudHidden>

    @* Mobile FABs for "View All Species" and "Species Near Me" when nothing selected *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        @if (clickedMunicipalityName == null && !showAllSpecies && !showNearbySpecies && viewingSpeciesLocations == null)
        {
            <div class="mobile-fab-container">
                <MudFab Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.List"
                        Label="@L["ViewAll"]"
                        Class="mobile-fab-item"
                        OnClick="@(() => LoadAllSpeciesCommand.ExecuteAsync(CancellationToken.None))" />
                @if (userLatitude.HasValue && userLongitude.HasValue)
                {
                    <MudFab Color="Color.Info"
                            StartIcon="@Icons.Material.Filled.NearMe"
                            Label="@L["NearMe_Button"]"
                            Class="mobile-fab-item"
                            OnClick="OpenSpeciesNearMe" />
                }
            </div>
        }
    </MudHidden>

    @* Bottom Location Navigator Overlay *@
    @if (viewingSpeciesLocations != null)
    {
        <LocationNavigator Species="viewingSpeciesLocations"
                           CurrentIndex="currentLocationIndex"
                           OnClose="ClearSpeciesLocations"
                           OnPrevious="PreviousLocation"
                           OnNext="NextLocation"
                           OnFocusCurrent="() => FocusOnLocation(currentLocationIndex)" />
    }
</div>

<SpeciesFilterDialog @bind-Visible="filterDialogVisible"
                     AvailableNrcsPractices="AvailableNrcsPractices"
                     AvailableFwsActions="AvailableFwsActions"
                     SelectedNrcsPractices="selectedNrcsPractices"
                     SelectedFwsActions="selectedFwsActions"
                     OnClearFilters="ClearAllFilters"
                     OnClose="CloseFilterDialog" />

@code {
    [CascadingParameter(Name = "LanguageRefresh")]
    private int LanguageRefresh { get; set; }

    [SupplyParameterFromQuery]
    public int? SpeciesId { get; set; }

    [SupplyParameterFromQuery]
    public bool RestoreNearMe { get; set; }

    private MunicipalityForListDto? selectedMunicipality;
    private string? clickedMunicipalityName;
    private IReadOnlyList<SpeciesForListDto> species = [];
    private IReadOnlyList<SpeciesForSearchDto> allSpecies = [];
    private IReadOnlyList<MunicipalityForListDto> municipalities = [];
    private SpeciesForDetailDto? viewingSpeciesLocations;
    private int currentLocationIndex = 0;
    private bool showAllSpecies = false;
    private bool sheetOpen = false;
    private bool sidebarOpen = true;
    private int? expandedSpeciesId;

    // Sort and Filter state
    private SortOption currentSort = SortOption.NameAZ;
    private HashSet<string> selectedNrcsPractices = new();
    private HashSet<string> selectedFwsActions = new();
    private bool filterDialogVisible = false;

    // Export state
    private bool isExporting = false;

    // Species Near Me state
    private double? userLatitude;
    private double? userLongitude;
    private bool showNearbySpecies = false;
    private int selectedRadiusKm = 5;
    private IReadOnlyList<SpeciesNearbyDto> nearbySpecies = [];
    private bool isLoadingNearbySpecies = false;
    private static readonly int[] RadiusOptions = [1, 5, 10, 25, 50];
    private bool showSpeciesLocationsOnMap = false;
    private Dictionary<int, string> speciesColors = new();

    private enum SortOption
    {
        NameAZ,
        NameZA,
        ScientificAZ,
        ScientificZA
    }

    private int ActiveFilterCount => selectedNrcsPractices.Count + selectedFwsActions.Count;

    private IEnumerable<string> AvailableNrcsPractices => species
        .SelectMany(s => s.FwsLinks)
        .Select(l => l.NrcsPractice.Code)
        .Distinct()
        .OrderBy(c => c);

    private IEnumerable<string> AvailableFwsActions => species
        .SelectMany(s => s.FwsLinks)
        .Select(l => l.FwsAction.Code)
        .Distinct()
        .OrderBy(c => c);

    private IReadOnlyList<SpeciesForListDto> FilteredSpecies
    {
        get
        {
            var filtered = species.AsEnumerable();

            // Apply NRCS Practice filter
            if (selectedNrcsPractices.Count > 0)
            {
                filtered = filtered.Where(s => s.FwsLinks.Any(l => selectedNrcsPractices.Contains(l.NrcsPractice.Code)));
            }

            // Apply FWS Action filter
            if (selectedFwsActions.Count > 0)
            {
                filtered = filtered.Where(s => s.FwsLinks.Any(l => selectedFwsActions.Contains(l.FwsAction.Code)));
            }

            // Apply sorting
            filtered = currentSort switch
            {
                SortOption.NameAZ => filtered.OrderBy(s => L.GetLocalizedValue(s.CommonName)),
                SortOption.NameZA => filtered.OrderByDescending(s => L.GetLocalizedValue(s.CommonName)),
                SortOption.ScientificAZ => filtered.OrderBy(s => s.ScientificName),
                SortOption.ScientificZA => filtered.OrderByDescending(s => s.ScientificName),
                _ => filtered
            };

            return filtered.ToList();
        }
    }

    private void OnSortChanged(SortOption newSort)
    {
        currentSort = newSort;
    }

    private void RemoveNrcsPracticeFilter(string practice)
    {
        selectedNrcsPractices.Remove(practice);
    }

    private void RemoveFwsActionFilter(string action)
    {
        selectedFwsActions.Remove(action);
    }

    private void ClearAllFilters()
    {
        selectedNrcsPractices.Clear();
        selectedFwsActions.Clear();
    }

    private void OpenFilterDialog()
    {
        filterDialogVisible = true;
    }

    private void CloseFilterDialog()
    {
        filterDialogVisible = false;
    }

    // Export methods
    private async Task ExportToPdf()
    {
        if (clickedMunicipalityName == null || species.Count == 0 || isExporting) return;

        isExporting = true;
        StateHasChanged();

        try
        {
            await Task.Run(async () =>
            {
                var pdfBytes = ReportService.GeneratePdfReport(clickedMunicipalityName, FilteredSpecies.ToList());
                var fileName = $"{clickedMunicipalityName.Replace(" ", "_")}_Species_Report.pdf";
                await DownloadFile(pdfBytes, fileName, "application/pdf");
            });
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private async Task ExportToCsv()
    {
        if (clickedMunicipalityName == null || species.Count == 0 || isExporting) return;

        isExporting = true;
        StateHasChanged();

        try
        {
            var csvBytes = ReportService.GenerateCsvReport(clickedMunicipalityName, FilteredSpecies.ToList());
            var fileName = $"{clickedMunicipalityName.Replace(" ", "_")}_Species_Report.csv";
            await DownloadFile(csvBytes, fileName, "text/csv");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private async Task DownloadFile(byte[] fileBytes, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JS.InvokeVoidAsync("downloadFile", base64, fileName, contentType);
    }

    private void ToggleSpecies(int speciesId, bool expanded)
    {
        expandedSpeciesId = expanded ? speciesId : null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            municipalities = await MunicipalityRepository.GetAllMunicipalitiesAsync();
            await JS.InvokeVoidAsync("leafletInterop.initMap", DotNetObjectReference.Create(this));

            // Check if we need to show species locations
            if (SpeciesId.HasValue)
            {
                await LoadSpeciesLocations(SpeciesId.Value);
            }
            // Check if we need to restore nearby species state
            else if (RestoreNearMe)
            {
                await RestoreNearbySpeciesState();
            }
        }
    }

    private async Task LoadSpeciesLocations(int speciesId)
    {
        viewingSpeciesLocations = await SpeciesRepository.GetSpeciesDetailAsync(speciesId);
        currentLocationIndex = 0;
        if (viewingSpeciesLocations?.Locations.Count > 0)
        {
            var locations = viewingSpeciesLocations.Locations.Select(l => new
            {
                latitude = l.Latitude,
                longitude = l.Longitude,
                radiusMeters = l.RadiusMeters,
                description = l.Description
            }).ToArray();

            await JS.InvokeVoidAsync("leafletInterop.showSpeciesLocations", viewingSpeciesLocations.CommonName, locations);

            // Focus on the first location
            await JS.InvokeVoidAsync("leafletInterop.focusOnLocation", 0);
        }
        StateHasChanged();
    }

    private async Task ClearSpeciesLocations()
    {
        await JS.InvokeVoidAsync("leafletInterop.clearSpeciesLocations");
        viewingSpeciesLocations = null;
        currentLocationIndex = 0;
        sheetOpen = false;
        NavigationManager.NavigateTo("/", replace: true);
    }

    private async Task FocusOnLocation(int index)
    {
        await JS.InvokeVoidAsync("leafletInterop.focusOnLocation", index);
    }

    private async Task FocusAllLocations()
    {
        await JS.InvokeVoidAsync("leafletInterop.focusAllLocations");
    }

    private async Task PreviousLocation()
    {
        if (currentLocationIndex > 0)
        {
            currentLocationIndex--;
            await FocusOnLocation(currentLocationIndex);
        }
    }

    private async Task NextLocation()
    {
        if (viewingSpeciesLocations != null && currentLocationIndex < viewingSpeciesLocations.Locations.Count - 1)
        {
            currentLocationIndex++;
            await FocusOnLocation(currentLocationIndex);
        }
    }

    [JSInvokable]
    public async Task OnMunicipalityClick(string geoJsonId, string name)
    {
        var municipality = municipalities?.FirstOrDefault(m => m.GeoJsonId == geoJsonId);

        if (municipality is null)
        {
            Snackbar.Add(L["MunicipalityNotFound", name], Severity.Warning);
            return;
        }

        showAllSpecies = false;
        showNearbySpecies = false;
        expandedSpeciesId = null;
        selectedMunicipality = municipality;
        clickedMunicipalityName = name;
        species = [];
        sheetOpen = false;
        sidebarOpen = true;

        // Clear nearby species search
        await JS.InvokeVoidAsync("leafletInterop.clearSearchRadius");

        // Reset filters when switching municipalities
        ClearAllFilters();
        currentSort = SortOption.NameAZ;

        StateHasChanged();

        // Small delay to allow DOM to render before triggering animation
        await Task.Delay(10);
        sheetOpen = true;
        StateHasChanged();

        await LoadMunicipalitySpeciesCommand.ExecuteAsync();
        StateHasChanged();
    }

    [JSInvokable]
    public void OnUserLocationFound(double latitude, double longitude)
    {
        userLatitude = latitude;
        userLongitude = longitude;
        StateHasChanged();
    }

    [RelayCommand]
    private async Task LoadMunicipalitySpecies()
    {
        if (selectedMunicipality != null)
        {
            species = await SpeciesRepository.GetSpeciesByMunicipalityAsync(selectedMunicipality.Id);
        }
    }

    [RelayCommand]
    private async Task LoadAllSpecies(CancellationToken cancellationToken)
    {
        showAllSpecies = true;
        selectedMunicipality = null;
        sheetOpen = false;
        sidebarOpen = true;
        StateHasChanged();

        await Task.Delay(10);
        sheetOpen = true;
        StateHasChanged();

        allSpecies = await SpeciesRepository.GetSpeciesAsync(new SpeciesParameters(PageSize: 500), cancellationToken);
    }

    private void ShowAllSpecies()
    {
        selectedMunicipality = null;
        clickedMunicipalityName = null;
        species = [];
        expandedSpeciesId = null;
    }

    private void CloseAllSpecies()
    {
        sheetOpen = false;
        sidebarOpen = false;
        allSpecies = [];
        showAllSpecies = false;
    }

    private void CloseSidebar()
    {
        sidebarOpen = false;
        selectedMunicipality = null;
        clickedMunicipalityName = null;
        showAllSpecies = false;
        species = [];
        allSpecies = [];
        expandedSpeciesId = null;
        ClearAllFilters();
    }

    private async Task CloseSheet()
    {
        sheetOpen = false;
        sidebarOpen = false;
        StateHasChanged();

        // Wait for close animation
        await Task.Delay(300);

        selectedMunicipality = null;
        clickedMunicipalityName = null;
        showAllSpecies = false;
        showNearbySpecies = false;
        species = [];
        allSpecies = [];
        nearbySpecies = [];
        expandedSpeciesId = null;
        ClearAllFilters();
        await JS.InvokeVoidAsync("leafletInterop.clearSearchRadius");
        StateHasChanged();
    }

    // Species Near Me methods
    private async Task OpenSpeciesNearMe()
    {
        if (userLatitude == null || userLongitude == null) return;

        showNearbySpecies = true;
        showAllSpecies = false;
        selectedMunicipality = null;
        clickedMunicipalityName = null;
        species = [];
        allSpecies = [];
        sheetOpen = false;
        sidebarOpen = true;

        StateHasChanged();

        await Task.Delay(10);
        sheetOpen = true;
        StateHasChanged();

        await SearchNearbySpecies();
    }

    private async Task SearchNearbySpecies()
    {
        if (userLatitude == null || userLongitude == null) return;

        // Clear existing species location circles if shown
        if (showSpeciesLocationsOnMap)
        {
            await JS.InvokeVoidAsync("leafletInterop.clearSpeciesLocationCircles");
            await JS.InvokeVoidAsync("leafletInterop.resetSpeciesColors");
            showSpeciesLocationsOnMap = false;
            speciesColors.Clear();
        }

        isLoadingNearbySpecies = true;
        StateHasChanged();

        try
        {
            var radiusMeters = selectedRadiusKm * 1000.0;

            // Show search radius on map
            await JS.InvokeVoidAsync("leafletInterop.showSearchRadius", radiusMeters);

            // Query nearby species
            nearbySpecies = await SpeciesRepository.GetSpeciesNearbyAsync(
                userLatitude.Value,
                userLongitude.Value,
                radiusMeters);

            // Show nearby species on map
            var speciesLocations = nearbySpecies.Select(s => new
            {
                id = s.Id,
                commonName = s.CommonName,
                scientificName = s.ScientificName,
                distanceMeters = s.DistanceMeters,
                latitude = s.Latitude,
                longitude = s.Longitude,
                radiusMeters = s.RadiusMeters,
                locationDescription = s.LocationDescription
            }).ToArray();

            await JS.InvokeVoidAsync("leafletInterop.showNearbySpecies", speciesLocations);
        }
        finally
        {
            isLoadingNearbySpecies = false;
            StateHasChanged();
        }
    }

    private async Task OnRadiusChanged(int newRadius)
    {
        selectedRadiusKm = newRadius;
        await SearchNearbySpecies();
    }

    private async Task CloseSpeciesNearMe()
    {
        showNearbySpecies = false;
        nearbySpecies = [];
        sidebarOpen = false;
        sheetOpen = false;
        showSpeciesLocationsOnMap = false;
        speciesColors.Clear();
        await JS.InvokeVoidAsync("leafletInterop.clearSearchRadius");
        await JS.InvokeVoidAsync("leafletInterop.clearSpeciesLocationCircles");
        await JS.InvokeVoidAsync("leafletInterop.resetSpeciesColors");
        StateHasChanged();
    }

    private async Task FocusOnNearbySpecies(int index)
    {
        await JS.InvokeVoidAsync("leafletInterop.focusOnNearbySpecies", index);
    }

    private async Task ToggleSpeciesLocationsOnMap()
    {
        showSpeciesLocationsOnMap = !showSpeciesLocationsOnMap;

        if (showSpeciesLocationsOnMap)
        {
            // Show species location circles on the map
            var speciesLocations = nearbySpecies.Select(s => new
            {
                id = s.Id,
                commonName = s.CommonName,
                scientificName = s.ScientificName,
                distanceMeters = s.DistanceMeters,
                latitude = s.Latitude,
                longitude = s.Longitude,
                radiusMeters = s.RadiusMeters,
                locationDescription = s.LocationDescription
            }).ToArray();

            await JS.InvokeVoidAsync("leafletInterop.showSpeciesLocationCircles", speciesLocations);

            // Get colors assigned to each species
            var colors = await JS.InvokeAsync<List<SpeciesColorEntry>>("leafletInterop.getSpeciesColors");
            speciesColors = colors.ToDictionary(c => c.Id, c => c.Color);
        }
        else
        {
            // Hide species location circles
            await JS.InvokeVoidAsync("leafletInterop.clearSpeciesLocationCircles");
            speciesColors.Clear();
        }

        StateHasChanged();
    }

    private record SpeciesColorEntry(
        [property: System.Text.Json.Serialization.JsonPropertyName("id")] int Id,
        [property: System.Text.Json.Serialization.JsonPropertyName("color")] string Color);

    // State preservation for Species Near Me
    private async Task NavigateToSpeciesDetail(int speciesId)
    {
        // Save current state to sessionStorage before navigating
        await SaveNearbySpeciesState();
        NavigationManager.NavigateTo($"/species/{speciesId}?returnUrl=/?restoreNearMe=true");
    }

    private async Task SaveNearbySpeciesState()
    {
        if (userLatitude.HasValue && userLongitude.HasValue)
        {
            var state = new
            {
                latitude = userLatitude.Value,
                longitude = userLongitude.Value,
                radiusKm = selectedRadiusKm
            };
            await JS.InvokeVoidAsync("sessionStorage.setItem", "nearbySpeciesState", System.Text.Json.JsonSerializer.Serialize(state));
        }
    }

    private async Task RestoreNearbySpeciesState()
    {
        try
        {
            var stateJson = await JS.InvokeAsync<string?>("sessionStorage.getItem", "nearbySpeciesState");
            if (!string.IsNullOrEmpty(stateJson))
            {
                var state = System.Text.Json.JsonSerializer.Deserialize<NearbySpeciesState>(stateJson);
                if (state != null)
                {
                    userLatitude = state.Latitude;
                    userLongitude = state.Longitude;
                    selectedRadiusKm = state.RadiusKm;

                    // Clear the saved state
                    await JS.InvokeVoidAsync("sessionStorage.removeItem", "nearbySpeciesState");

                    // Clear the query parameter from URL
                    NavigationManager.NavigateTo("/", replace: true);

                    // Re-open the Species Near Me panel and search
                    await OpenSpeciesNearMe();
                }
            }
        }
        catch
        {
            // Ignore errors when restoring state
        }
    }

    private record NearbySpeciesState(
        [property: System.Text.Json.Serialization.JsonPropertyName("latitude")] double Latitude,
        [property: System.Text.Json.Serialization.JsonPropertyName("longitude")] double Longitude,
        [property: System.Text.Json.Serialization.JsonPropertyName("radiusKm")] int RadiusKm);
}
