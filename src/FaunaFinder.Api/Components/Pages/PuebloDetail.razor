@page "/pueblos/{Id:int}"
@using BlazingSingularity.Commands
@inject IMunicipalityRepository MunicipalityRepository
@inject ISpeciesRepository SpeciesRepository
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@(municipality?.Name ?? "Pueblo") - FaunaFinder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @* Back Navigation *@
    <MudButton Variant="Variant.Text"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.ArrowBack"
               OnClick="NavigateBack"
               Class="mb-4">
        @L["Back"]
    </MudButton>

    @if (LoadDataCommand.IsLoading)
    {
        @* Municipality Header Skeleton *@
        <MudPaper Elevation="2" Class="pa-4 mb-6">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" Width="50%" Class="mb-3 rounded" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="24px" Width="30%" Class="rounded" />
        </MudPaper>

        @* Species List Section Skeleton *@
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="32px" Width="40%" Class="mb-4 rounded" />

        @for (int i = 0; i < 6; i++)
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-3 rounded" />
        }
    }
    else if (municipality == null)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
            @L["Error_MunicipalityNotFound"]
        </MudAlert>
    }
    else
    {
        @* Municipality Header *@
        <MudPaper Elevation="2" Class="pa-4 mb-6">
            <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@municipality.Name</MudText>
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Medium" Color="Color.Secondary" Class="mr-2" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">
                    @municipality.SpeciesCount @L["Pueblos_Species"]
                </MudText>
            </div>
        </MudPaper>

        @* Species List *@
        <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true" Class="mb-4">@L["PuebloDetail_SpeciesInMunicipality"]</MudText>

        @if (species.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
                @L["PuebloDetail_NoSpeciesData"]
            </MudAlert>
        }
        else
        {
            <MudExpansionPanels MultiExpansion="false" Elevation="1">
                @foreach (var s in species)
                {
                    <MudExpansionPanel Expanded="@(expandedSpeciesId == s.Id)"
                                       ExpandedChanged="@((bool expanded) => ToggleSpecies(s.Id, expanded))"
                                       Class="mb-2 pa-2">
                        <TitleContent>
                            <div class="d-flex flex-column flex-sm-row align-start align-sm-center justify-space-between" style="width: 100%;">
                                <div class="d-flex flex-column flex-sm-row align-start align-sm-center">
                                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mr-4">@s.CommonName</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        <em>@s.ScientificName</em>
                                    </MudText>
                                </div>
                                <div @onclick:stopPropagation="true">
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               EndIcon="@Icons.Material.Filled.OpenInNew"
                                               OnClick="@(() => NavigateToSpecies(s.Id))">
                                        @L["ViewDetails"]
                                    </MudButton>
                                </div>
                            </div>
                        </TitleContent>
                        <ChildContent>
                            @if (s.FwsLinks.Any())
                            {
                                <MudText Typo="Typo.overline" Color="Color.Primary" Class="mb-3">@L["Map_ConservationLinks"]</MudText>
                                <MudGrid Spacing="2">
                                    @foreach (var link in s.FwsLinks)
                                    {
                                        <MudItem xs="12" md="6">
                                            <MudPaper Elevation="0" Class="pa-3 bg-subtle">
                                                <div class="d-flex flex-wrap align-start gap-2 mb-2">
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                                        NRCS @link.NrcsPractice.Code
                                                    </MudChip>
                                                    <MudText Typo="Typo.body2">@link.NrcsPractice.Name</MudText>
                                                </div>
                                                <div class="d-flex flex-wrap align-start gap-2 mb-2">
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">
                                                        FWS @link.FwsAction.Code
                                                    </MudChip>
                                                    <MudText Typo="Typo.body2">@link.FwsAction.Name</MudText>
                                                </div>
                                                @if (!string.IsNullOrEmpty(link.Justification))
                                                {
                                                    <MudDivider Class="my-2" />
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @link.Justification
                                                    </MudText>
                                                }
                                            </MudPaper>
                                        </MudItem>
                                    }
                                </MudGrid>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @L["PuebloDetail_NoConservationLinks"]
                                </MudText>
                            }
                        </ChildContent>
                    </MudExpansionPanel>
                }
            </MudExpansionPanels>
        }
    }
</MudContainer>

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private MunicipalityForDetailDto? municipality;
    private IReadOnlyList<SpeciesForListDto> species = [];
    private int? expandedSpeciesId;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataCommand.ExecuteAsync();
    }

    [RelayCommand]
    private async Task LoadData()
    {
        municipality = await MunicipalityRepository.GetMunicipalityDetailAsync(Id);

        if (municipality != null)
        {
            species = await SpeciesRepository.GetSpeciesByMunicipalityAsync(Id);
        }
    }

    private void ToggleSpecies(int speciesId, bool expanded)
    {
        expandedSpeciesId = expanded ? speciesId : null;
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo(string.IsNullOrEmpty(ReturnUrl) ? "/pueblos" : ReturnUrl);
    }

    private void NavigateToSpecies(int speciesId)
    {
        NavigationManager.NavigateTo($"/species/{speciesId}?returnUrl=/pueblos/{Id}");
    }
}
