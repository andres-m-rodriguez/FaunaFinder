@page "/search"
@inject ISpeciesRepository SpeciesRepository

<PageTitle>Search Species - FaunaFinder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">Search Species</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Search for species by common name or scientific name.
    </MudText>

    <MudTextField @bind-Value="searchTerm"
                  Placeholder="Type to search species..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="OnSearchChanged"
                  Clearable="true"
                  Class="mb-4 search-input"
                  FullWidth="true" />

    @if (isLoading)
    {
        <MudContainer Class="d-flex justify-center py-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </MudContainer>
    }
    else if (string.IsNullOrWhiteSpace(searchTerm))
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-2" />
            Start typing to search for species by common name or scientific name.
        </MudAlert>
    }
    else if (searchResults.Count == 0)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-4">
            No species found matching "@searchTerm".
        </MudAlert>
    }
    else
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
            Found @searchResults.Count @(searchResults.Count == 1 ? "species" : "species") matching "@searchTerm"
        </MudText>

        <MudGrid Spacing="3">
            @foreach (var species in searchResults)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Class="species-card h-100">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary">
                                @HighlightText(species.CommonName, searchTerm)
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="font-italic mb-3">
                                @HighlightText(species.ScientificName, searchTerm)
                            </MudText>

                            @if (species.MunicipalityNames.Count > 0)
                            {
                                <div class="d-flex align-center mb-2">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Primary" Class="mr-1" />
                                    <MudText Typo="Typo.caption" Color="Color.Primary">
                                        Found in @species.MunicipalityNames.Count @(species.MunicipalityNames.Count == 1 ? "municipality" : "municipalities")
                                    </MudText>
                                </div>
                                <div class="municipality-chips">
                                    @foreach (var municipality in species.MunicipalityNames.Take(5))
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined" Class="ma-1">
                                            @municipality
                                        </MudChip>
                                    }
                                    @if (species.MunicipalityNames.Count > 5)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" Class="ma-1">
                                            +@(species.MunicipalityNames.Count - 5) more
                                        </MudChip>
                                    }
                                </div>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                    No municipality data available
                                </MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<style>
    .search-input .mud-input-root {
        font-size: 1.1rem;
    }

    .species-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .species-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }

    .municipality-chips {
        display: flex;
        flex-wrap: wrap;
        margin: -4px;
    }

    .highlight {
        background-color: #fff59d;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: 600;
    }

    @@media (max-width: 600px) {
        .search-input .mud-input-root {
            font-size: 1rem;
        }
    }
</style>

@code {
    private IReadOnlyList<SpeciesForSearchDto> searchResults = [];
    private string searchTerm = string.Empty;
    private bool isLoading = false;

    private async Task OnSearchChanged()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            searchResults = [];
            return;
        }

        isLoading = true;
        StateHasChanged();

        var parameters = new SpeciesParameters(
            Limit: 50,
            Search: searchTerm
        );

        searchResults = await SpeciesRepository.SearchSpeciesAsync(parameters);

        isLoading = false;
        StateHasChanged();
    }

    private RenderFragment HighlightText(string text, string searchText)
    {
        return builder =>
        {
            if (string.IsNullOrWhiteSpace(searchText))
            {
                builder.AddContent(0, text);
                return;
            }

            var lowerText = text.ToLower();
            var lowerSearch = searchText.ToLower();
            var currentIndex = 0;
            var sequence = 0;

            while (currentIndex < text.Length)
            {
                var matchIndex = lowerText.IndexOf(lowerSearch, currentIndex, StringComparison.Ordinal);
                if (matchIndex < 0)
                {
                    builder.AddContent(sequence++, text[currentIndex..]);
                    break;
                }

                if (matchIndex > currentIndex)
                {
                    builder.AddContent(sequence++, text[currentIndex..matchIndex]);
                }

                builder.OpenElement(sequence++, "span");
                builder.AddAttribute(sequence++, "class", "highlight");
                builder.AddContent(sequence++, text.Substring(matchIndex, searchText.Length));
                builder.CloseElement();

                currentIndex = matchIndex + searchText.Length;
            }
        };
    }
}
