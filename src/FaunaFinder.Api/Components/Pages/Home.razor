@page "/"
@using BlazingSingularity.Commands
@inject IMunicipalityRepository MunicipalityRepository
@inject ISpeciesRepository SpeciesRepository
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject IAppLocalizer L

<PageTitle>@L["PageTitle_Home"]</PageTitle>

<div class="map-page">
    <div class="map-container">
        <div id="map" class="map"></div>
    </div>

    @* Desktop Sidebar *@
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <div class="desktop-sidebar @(sidebarOpen ? "open" : "")">
            @if (LoadMunicipalitySpeciesCommand.IsLoading || LoadAllSpeciesCommand.IsLoading)
            {
                <MudPaper Class="pa-3 mud-theme-primary" Square="true" Elevation="0">
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.subtitle1">@(clickedMunicipalityName ?? L["AllSpecies"])</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" Size="Size.Small" OnClick="CloseSidebar" />
                    </div>
                </MudPaper>
                <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 200px;">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    <MudText Typo="Typo.body2" Class="mt-3">@L["Loading"]</MudText>
                </MudContainer>
            }
            else if (clickedMunicipalityName != null)
            {
                <MudPaper Class="pa-3 mud-theme-primary" Square="true" Elevation="0">
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.subtitle1">@clickedMunicipalityName</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" Size="Size.Small" OnClick="CloseSidebar" />
                    </div>
                </MudPaper>

                @* Filter/Sort Toolbar *@
                @if (species.Count > 0)
                {
                    <MudPaper Class="px-3 py-2" Square="true" Elevation="0">
                        <div class="d-flex align-center gap-2 flex-wrap">
                            <MudSelect T="SortOption" Value="currentSort" ValueChanged="OnSortChanged"
                                       Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                                       Style="max-width: 150px;" Label="@L["Filter_Sort"]">
                                <MudSelectItem Value="SortOption.NameAZ">@L["Filter_NameAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.NameZA">@L["Filter_NameZA"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificAZ">@L["Filter_ScientificAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificZA">@L["Filter_ScientificZA"]</MudSelectItem>
                            </MudSelect>

                            <MudMenu Icon="@Icons.Material.Filled.FilterList" Size="Size.Small" Dense="true"
                                     AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                                <MudMenuItem OnClick="OpenFilterDialog">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Tune" Size="Size.Small" />
                                        <span>@L["Filter_Filters"]</span>
                                        @if (ActiveFilterCount > 0)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@ActiveFilterCount</MudChip>
                                        }
                                    </div>
                                </MudMenuItem>
                                @if (ActiveFilterCount > 0)
                                {
                                    <MudMenuItem OnClick="ClearAllFilters">
                                        <div class="d-flex align-center gap-2">
                                            <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" />
                                            <span>@L["Filter_ClearAll"]</span>
                                        </div>
                                    </MudMenuItem>
                                }
                            </MudMenu>
                        </div>

                        @* Active filter chips *@
                        @if (ActiveFilterCount > 0)
                        {
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                @foreach (var practice in selectedNrcsPractices)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" OnClose="() => RemoveNrcsPracticeFilter(practice)">
                                        NRCS @practice
                                    </MudChip>
                                }
                                @foreach (var action in selectedFwsActions)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" OnClose="() => RemoveFwsActionFilter(action)">
                                        FWS @action
                                    </MudChip>
                                }
                            </div>
                        }
                    </MudPaper>
                }

                <div class="sidebar-content">
                    @if (species.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                            @L["Home_NoSpeciesData"]
                        </MudAlert>
                    }
                    else
                    {
                        <div class="pa-3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @if (ActiveFilterCount > 0)
                                {
                                    @string.Format(L["Filter_ShowingFiltered"], FilteredSpecies.Count, species.Count)
                                }
                                else
                                {
                                    @string.Format(L["Home_SpeciesFound"], species.Count)
                                }
                            </MudText>

                            @if (FilteredSpecies.Count == 0)
                            {
                                <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-2">
                                    @L["Filter_NoMatches"]
                                </MudAlert>
                            }

                            <MudExpansionPanels MultiExpansion="false" Elevation="0">
                                @foreach (var s in FilteredSpecies)
                                {
                                    <MudExpansionPanel Expanded="@(expandedSpeciesId == s.Id)"
                                                       ExpandedChanged="@((bool expanded) => ToggleSpecies(s.Id, expanded))"
                                                       Class="mb-2 border-default">
                                        <TitleContent>
                                            <div>
                                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">@s.CommonName</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    <em>@s.ScientificName</em>
                                                </MudText>
                                            </div>
                                        </TitleContent>
                                        <ChildContent>
                                            @if (s.FwsLinks.Any())
                                            {
                                                <MudText Typo="Typo.overline" Color="Color.Primary" Class="mb-2">@L["Home_ConservationLinks"]</MudText>
                                                @foreach (var link in s.FwsLinks)
                                                {
                                                    <MudPaper Elevation="0" Class="pa-2 mb-2 bg-subtle">
                                                        <div class="d-flex align-start gap-2 mb-1">
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                                                NRCS @link.NrcsPractice.Code
                                                            </MudChip>
                                                            <MudText Typo="Typo.body2">@link.NrcsPractice.Name</MudText>
                                                        </div>
                                                        <div class="d-flex align-start gap-2 mb-1">
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">
                                                                FWS @link.FwsAction.Code
                                                            </MudChip>
                                                            <MudText Typo="Typo.body2">@link.FwsAction.Name</MudText>
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(link.Justification))
                                                        {
                                                            <MudDivider Class="my-2" />
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                @link.Justification
                                                            </MudText>
                                                        }
                                                    </MudPaper>
                                                }
                                            }
                                        </ChildContent>
                                    </MudExpansionPanel>
                                }
                            </MudExpansionPanels>
                        </div>
                    }
                </div>
            }
            else if (showAllSpecies)
            {
                <MudPaper Class="pa-3 mud-theme-primary" Square="true" Elevation="0">
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.subtitle1">@L["AllSpecies"]</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" Size="Size.Small" OnClick="CloseSidebar" />
                    </div>
                </MudPaper>

                <div class="sidebar-content pa-3">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                        @string.Format(L["Home_SpeciesInDatabase"], allSpecies.Count)
                    </MudText>

                    <MudList T="SpeciesForSearchDto" Dense="true">
                        @foreach (var s in allSpecies)
                        {
                            <MudListItem>
                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">@s.CommonName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <em>@s.ScientificName</em>
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                </div>
            }
            else if (showNearbySpecies)
            {
                <MudPaper Class="pa-3 mud-theme-info" Square="true" Elevation="0">
                    <div class="d-flex justify-space-between align-center">
                        <div class="d-flex align-center gap-2">
                            <MudIcon Icon="@Icons.Material.Filled.NearMe" Size="Size.Small" />
                            <MudText Typo="Typo.subtitle1">@L["NearMe_Title"]</MudText>
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" Size="Size.Small" OnClick="CloseSpeciesNearMe" />
                    </div>
                </MudPaper>

                <MudPaper Class="px-3 py-2" Square="true" Elevation="0">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">@L["NearMe_SelectRadius"]</MudText>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var radius in RadiusOptions)
                        {
                            <MudChip T="string"
                                     Color="@(selectedRadiusKm == radius ? Color.Info : Color.Default)"
                                     Variant="@(selectedRadiusKm == radius ? Variant.Filled : Variant.Outlined)"
                                     OnClick="() => OnRadiusChanged(radius)"
                                     Size="Size.Small">
                                @($"{radius} km")
                            </MudChip>
                        }
                    </div>
                </MudPaper>

                <div class="sidebar-content">
                    @if (isLoadingNearbySpecies)
                    {
                        <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 200px;">
                            <MudProgressCircular Color="Color.Info" Indeterminate="true" />
                            <MudText Typo="Typo.body2" Class="mt-3">@L["NearMe_Searching"]</MudText>
                        </MudContainer>
                    }
                    else if (nearbySpecies.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                            @L["NearMe_NoSpeciesFound"]
                        </MudAlert>
                    }
                    else
                    {
                        <div class="pa-3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @string.Format(L["NearMe_SpeciesFound"], nearbySpecies.Count, selectedRadiusKm)
                            </MudText>

                            <MudList T="SpeciesNearbyDto" Dense="true" Class="nearby-species-list">
                                @for (var i = 0; i < nearbySpecies.Count; i++)
                                {
                                    var index = i;
                                    var s = nearbySpecies[i];
                                    <MudListItem Class="nearby-species-item pa-2 mb-2 rounded border-default" OnClick="() => FocusOnNearbySpecies(index)">
                                        <div class="d-flex justify-space-between align-start">
                                            <div>
                                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">@s.CommonName</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    <em>@s.ScientificName</em>
                                                </MudText>
                                                @if (!string.IsNullOrEmpty(s.LocationDescription))
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @s.LocationDescription
                                                    </MudText>
                                                }
                                            </div>
                                            <div class="text-right">
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                                                    @FormatDistance(s.DistanceMeters)
                                                </MudChip>
                                                <MudIconButton Icon="@Icons.Material.Filled.Info"
                                                               Size="Size.Small"
                                                               Href="@($"/species/{s.Id}")"
                                                               Color="Color.Primary" />
                                            </div>
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        </div>
                    }
                </div>
            }
            else
            {
                <MudPaper Class="pa-3 mud-theme-primary" Square="true" Elevation="0">
                    <MudText Typo="Typo.subtitle1">@L["AppTitle"]</MudText>
                </MudPaper>

                <div class="pa-4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        @L["Home_ClickMunicipality"]
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Class="mb-2"
                               OnClick="@(() => LoadAllSpeciesCommand.ExecuteAsync(CancellationToken.None))">
                        @L["ViewAllSpecies"]
                    </MudButton>
                    @if (userLatitude.HasValue && userLongitude.HasValue)
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Info"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.NearMe"
                                   OnClick="OpenSpeciesNearMe">
                            @L["NearMe_Button"]
                        </MudButton>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-2">
                            @L["NearMe_UseLocateFirst"]
                        </MudAlert>
                    }
                </div>
            }
        </div>
    </MudHidden>

    @* Mobile Bottom Sheet *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        @if (clickedMunicipalityName != null || showAllSpecies || showNearbySpecies)
        {
            <div class="mobile-sheet-backdrop @(sheetOpen ? "open" : "")" @onclick="CloseSheet"></div>
            <div class="mobile-sheet @(sheetOpen ? "open" : "")">
                <div class="mobile-sheet-header">
                    <MudText Typo="Typo.subtitle1" Class="ml-3">
                        @(showNearbySpecies ? L["NearMe_Title"] : (clickedMunicipalityName ?? L["AllSpecies"]))
                    </MudText>
                    <MudSpacer />
                    @if (clickedMunicipalityName != null && species.Count > 0)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.FilterList"
                                       Size="Size.Small"
                                       OnClick="OpenFilterDialog"
                                       Color="@(ActiveFilterCount > 0 ? Color.Primary : Color.Default)" />
                    }
                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                   Size="Size.Medium"
                                   OnClick="CloseSheet" />
                </div>

                @* Mobile Sort/Filter Bar *@
                @if (clickedMunicipalityName != null && species.Count > 0)
                {
                    <div class="px-3 py-2">
                        <div class="d-flex align-center gap-2">
                            <MudSelect T="SortOption" Value="currentSort" ValueChanged="OnSortChanged"
                                       Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined"
                                       Style="flex: 1;" Label="@L["Filter_Sort"]">
                                <MudSelectItem Value="SortOption.NameAZ">@L["Filter_NameAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.NameZA">@L["Filter_NameZA"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificAZ">@L["Filter_ScientificAZ"]</MudSelectItem>
                                <MudSelectItem Value="SortOption.ScientificZA">@L["Filter_ScientificZA"]</MudSelectItem>
                            </MudSelect>
                            @if (ActiveFilterCount > 0)
                            {
                                <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="ClearAllFilters">
                                    @L["Filter_ClearAll"]
                                </MudButton>
                            }
                        </div>

                        @if (ActiveFilterCount > 0)
                        {
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                @foreach (var practice in selectedNrcsPractices)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" OnClose="() => RemoveNrcsPracticeFilter(practice)">
                                        NRCS @practice
                                    </MudChip>
                                }
                                @foreach (var action in selectedFwsActions)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" OnClose="() => RemoveFwsActionFilter(action)">
                                        FWS @action
                                    </MudChip>
                                }
                            </div>
                        }
                    </div>
                }

                @if (LoadMunicipalitySpeciesCommand.IsLoading || LoadAllSpeciesCommand.IsLoading)
                {
                    <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 200px;">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                        <MudText Typo="Typo.body2" Class="mt-3">@L["Loading"]</MudText>
                    </MudContainer>
                }
                else if (clickedMunicipalityName != null)
                {
                    <MudContainer Class="pa-3" MaxWidth="MaxWidth.False">
                        @if (species.Count == 0)
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Text">
                                @L["Home_NoSpeciesData"]
                            </MudAlert>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @if (ActiveFilterCount > 0)
                                {
                                    @string.Format(L["Filter_ShowingFiltered"], FilteredSpecies.Count, species.Count)
                                }
                                else
                                {
                                    @string.Format(L["Home_SpeciesFound"], species.Count)
                                }
                            </MudText>

                            @if (FilteredSpecies.Count == 0)
                            {
                                <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-2">
                                    @L["Filter_NoMatches"]
                                </MudAlert>
                            }

                            <MudExpansionPanels MultiExpansion="false" Elevation="0">
                                @foreach (var s in FilteredSpecies)
                                {
                                    <MudExpansionPanel Expanded="@(expandedSpeciesId == s.Id)"
                                                       ExpandedChanged="@((bool expanded) => ToggleSpecies(s.Id, expanded))"
                                                       Class="mb-2 border-default">
                                        <TitleContent>
                                            <div>
                                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">@s.CommonName</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    <em>@s.ScientificName</em>
                                                </MudText>
                                            </div>
                                        </TitleContent>
                                        <ChildContent>
                                            @if (s.FwsLinks.Any())
                                            {
                                                <MudText Typo="Typo.overline" Color="Color.Primary" Class="mb-2">@L["Home_ConservationLinks"]</MudText>
                                                @foreach (var link in s.FwsLinks)
                                                {
                                                    <MudPaper Elevation="0" Class="pa-2 mb-2 bg-subtle">
                                                        <div class="d-flex align-start gap-2 mb-1">
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                                                NRCS @link.NrcsPractice.Code
                                                            </MudChip>
                                                            <MudText Typo="Typo.body2">@link.NrcsPractice.Name</MudText>
                                                        </div>
                                                        <div class="d-flex align-start gap-2 mb-1">
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">
                                                                FWS @link.FwsAction.Code
                                                            </MudChip>
                                                            <MudText Typo="Typo.body2">@link.FwsAction.Name</MudText>
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(link.Justification))
                                                        {
                                                            <MudDivider Class="my-2" />
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                @link.Justification
                                                            </MudText>
                                                        }
                                                    </MudPaper>
                                                }
                                            }
                                        </ChildContent>
                                    </MudExpansionPanel>
                                }
                            </MudExpansionPanels>
                        }
                    </MudContainer>
                }
                else if (showAllSpecies)
                {
                    <MudContainer Class="pa-3" MaxWidth="MaxWidth.False">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                            @string.Format(L["Home_SpeciesInDatabase"], allSpecies.Count)
                        </MudText>

                        <MudList T="SpeciesForSearchDto" Dense="true">
                            @foreach (var s in allSpecies)
                            {
                                <MudListItem>
                                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">@s.CommonName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        <em>@s.ScientificName</em>
                                    </MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </MudContainer>
                }
                else if (showNearbySpecies)
                {
                    <div class="px-3 py-2">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">@L["NearMe_SelectRadius"]</MudText>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var radius in RadiusOptions)
                            {
                                <MudChip T="string"
                                         Color="@(selectedRadiusKm == radius ? Color.Info : Color.Default)"
                                         Variant="@(selectedRadiusKm == radius ? Variant.Filled : Variant.Outlined)"
                                         OnClick="() => OnRadiusChanged(radius)"
                                         Size="Size.Small">
                                    @($"{radius} km")
                                </MudChip>
                            }
                        </div>
                    </div>

                    @if (isLoadingNearbySpecies)
                    {
                        <MudContainer Class="d-flex flex-column align-center justify-center" Style="height: 200px;">
                            <MudProgressCircular Color="Color.Info" Indeterminate="true" />
                            <MudText Typo="Typo.body2" Class="mt-3">@L["NearMe_Searching"]</MudText>
                        </MudContainer>
                    }
                    else if (nearbySpecies.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="ma-3">
                            @L["NearMe_NoSpeciesFound"]
                        </MudAlert>
                    }
                    else
                    {
                        <MudContainer Class="pa-3" MaxWidth="MaxWidth.False">
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                @string.Format(L["NearMe_SpeciesFound"], nearbySpecies.Count, selectedRadiusKm)
                            </MudText>

                            <MudList T="SpeciesNearbyDto" Dense="true" Class="nearby-species-list">
                                @for (var i = 0; i < nearbySpecies.Count; i++)
                                {
                                    var index = i;
                                    var s = nearbySpecies[i];
                                    <MudListItem Class="nearby-species-item pa-2 mb-2 rounded border-default" OnClick="() => FocusOnNearbySpecies(index)">
                                        <div class="d-flex justify-space-between align-start">
                                            <div>
                                                <MudText Typo="Typo.subtitle2" Color="Color.Primary">@s.CommonName</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    <em>@s.ScientificName</em>
                                                </MudText>
                                            </div>
                                            <div class="text-right">
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                                                    @FormatDistance(s.DistanceMeters)
                                                </MudChip>
                                                <MudIconButton Icon="@Icons.Material.Filled.Info"
                                                               Size="Size.Small"
                                                               Href="@($"/species/{s.Id}")"
                                                               Color="Color.Primary" />
                                            </div>
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudContainer>
                    }
                }
            </div>
        }
    </MudHidden>

    @* Mobile FABs for "View All Species" and "Species Near Me" when nothing selected *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        @if (clickedMunicipalityName == null && !showAllSpecies && !showNearbySpecies && viewingSpeciesLocations == null)
        {
            <div class="mobile-fab-container">
                <MudFab Color="Color.Primary"
                        StartIcon="@Icons.Material.Filled.List"
                        Label="@L["ViewAll"]"
                        Class="mobile-fab-item"
                        OnClick="@(() => LoadAllSpeciesCommand.ExecuteAsync(CancellationToken.None))" />
                @if (userLatitude.HasValue && userLongitude.HasValue)
                {
                    <MudFab Color="Color.Info"
                            StartIcon="@Icons.Material.Filled.NearMe"
                            Label="@L["NearMe_Button"]"
                            Class="mobile-fab-item"
                            OnClick="OpenSpeciesNearMe" />
                }
            </div>
        }
    </MudHidden>

    @* Bottom Location Navigator Overlay *@
    @if (viewingSpeciesLocations != null)
    {
        <div class="location-nav-overlay">
            <div class="location-nav-header">
                <MudIcon Icon="@Icons.Material.Filled.MyLocation" Size="Size.Small" Class="mr-2" />
                <MudText Typo="Typo.body2" Style="font-weight: 500;">@viewingSpeciesLocations.CommonName</MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Text"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           Href="@($"/species/{viewingSpeciesLocations.Id}")"
                           Class="mr-2">
                    @L["ViewDetails"]
                </MudButton>
                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               Size="Size.Small"
                               OnClick="ClearSpeciesLocations" />
            </div>
            <div class="location-nav-content">
                <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                               Size="Size.Large"
                               Disabled="@(currentLocationIndex == 0)"
                               OnClick="PreviousLocation" />
                <div class="location-nav-info" @onclick="() => FocusOnLocation(currentLocationIndex)">
                    <MudText Typo="Typo.body1" Align="Align.Center">
                        @(viewingSpeciesLocations.Locations[currentLocationIndex].Description ?? L["Home_UnnamedLocation"])
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @($"{currentLocationIndex + 1} / {viewingSpeciesLocations.Locations.Count}") &bull; @($"{viewingSpeciesLocations.Locations[currentLocationIndex].RadiusMeters:N0}m radius")
                    </MudText>
                </div>
                <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                               Size="Size.Large"
                               Disabled="@(currentLocationIndex >= viewingSpeciesLocations.Locations.Count - 1)"
                               OnClick="NextLocation" />
            </div>
        </div>
    }
</div>

@* Filter Dialog *@
<MudDialog @bind-Visible="filterDialogVisible" Options="new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true }">
    <TitleContent>
        <MudText Typo="Typo.h6">@L["Filter_Filters"]</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.subtitle2" Class="mb-2">@L["Filter_NrcsPractices"]</MudText>
        <div class="d-flex flex-wrap gap-1 mb-4">
            @foreach (var practice in AvailableNrcsPractices)
            {
                <MudChip T="string"
                         Color="@(selectedNrcsPractices.Contains(practice) ? Color.Primary : Color.Default)"
                         Variant="@(selectedNrcsPractices.Contains(practice) ? Variant.Filled : Variant.Outlined)"
                         OnClick="() => ToggleNrcsPracticeFilter(practice)">
                    @practice
                </MudChip>
            }
        </div>

        <MudText Typo="Typo.subtitle2" Class="mb-2">@L["Filter_FwsActions"]</MudText>
        <div class="d-flex flex-wrap gap-1">
            @foreach (var action in AvailableFwsActions)
            {
                <MudChip T="string"
                         Color="@(selectedFwsActions.Contains(action) ? Color.Secondary : Color.Default)"
                         Variant="@(selectedFwsActions.Contains(action) ? Variant.Filled : Variant.Outlined)"
                         OnClick="() => ToggleFwsActionFilter(action)">
                    @action
                </MudChip>
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="ClearAllFilters" Color="Color.Default">@L["Filter_ClearAll"]</MudButton>
        <MudButton OnClick="CloseFilterDialog" Color="Color.Primary" Variant="Variant.Filled">@L["Filter_Apply"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [SupplyParameterFromQuery]
    public int? SpeciesId { get; set; }

    private MunicipalityForListDto? selectedMunicipality;
    private string? clickedMunicipalityName;
    private IReadOnlyList<SpeciesForListDto> species = [];
    private IReadOnlyList<SpeciesForSearchDto> allSpecies = [];
    private IReadOnlyList<MunicipalityForListDto> municipalities = [];
    private SpeciesForDetailDto? viewingSpeciesLocations;
    private int currentLocationIndex = 0;
    private bool showAllSpecies = false;
    private bool sheetOpen = false;
    private bool sidebarOpen = true;
    private int? expandedSpeciesId;

    // Sort and Filter state
    private SortOption currentSort = SortOption.NameAZ;
    private HashSet<string> selectedNrcsPractices = new();
    private HashSet<string> selectedFwsActions = new();
    private bool filterDialogVisible = false;

    // Species Near Me state
    private double? userLatitude;
    private double? userLongitude;
    private bool showNearbySpecies = false;
    private int selectedRadiusKm = 5;
    private IReadOnlyList<SpeciesNearbyDto> nearbySpecies = [];
    private bool isLoadingNearbySpecies = false;
    private static readonly int[] RadiusOptions = [1, 5, 10, 25, 50];

    private enum SortOption
    {
        NameAZ,
        NameZA,
        ScientificAZ,
        ScientificZA
    }

    private int ActiveFilterCount => selectedNrcsPractices.Count + selectedFwsActions.Count;

    private IEnumerable<string> AvailableNrcsPractices => species
        .SelectMany(s => s.FwsLinks)
        .Select(l => l.NrcsPractice.Code)
        .Distinct()
        .OrderBy(c => c);

    private IEnumerable<string> AvailableFwsActions => species
        .SelectMany(s => s.FwsLinks)
        .Select(l => l.FwsAction.Code)
        .Distinct()
        .OrderBy(c => c);

    private IReadOnlyList<SpeciesForListDto> FilteredSpecies
    {
        get
        {
            var filtered = species.AsEnumerable();

            // Apply NRCS Practice filter
            if (selectedNrcsPractices.Count > 0)
            {
                filtered = filtered.Where(s => s.FwsLinks.Any(l => selectedNrcsPractices.Contains(l.NrcsPractice.Code)));
            }

            // Apply FWS Action filter
            if (selectedFwsActions.Count > 0)
            {
                filtered = filtered.Where(s => s.FwsLinks.Any(l => selectedFwsActions.Contains(l.FwsAction.Code)));
            }

            // Apply sorting
            filtered = currentSort switch
            {
                SortOption.NameAZ => filtered.OrderBy(s => s.CommonName),
                SortOption.NameZA => filtered.OrderByDescending(s => s.CommonName),
                SortOption.ScientificAZ => filtered.OrderBy(s => s.ScientificName),
                SortOption.ScientificZA => filtered.OrderByDescending(s => s.ScientificName),
                _ => filtered
            };

            return filtered.ToList();
        }
    }

    private void OnSortChanged(SortOption newSort)
    {
        currentSort = newSort;
    }

    private void ToggleNrcsPracticeFilter(string practice)
    {
        if (!selectedNrcsPractices.Remove(practice))
        {
            selectedNrcsPractices.Add(practice);
        }
    }

    private void ToggleFwsActionFilter(string action)
    {
        if (!selectedFwsActions.Remove(action))
        {
            selectedFwsActions.Add(action);
        }
    }

    private void RemoveNrcsPracticeFilter(string practice)
    {
        selectedNrcsPractices.Remove(practice);
    }

    private void RemoveFwsActionFilter(string action)
    {
        selectedFwsActions.Remove(action);
    }

    private void ClearAllFilters()
    {
        selectedNrcsPractices.Clear();
        selectedFwsActions.Clear();
    }

    private void OpenFilterDialog()
    {
        filterDialogVisible = true;
    }

    private void CloseFilterDialog()
    {
        filterDialogVisible = false;
    }

    private void ToggleSpecies(int speciesId, bool expanded)
    {
        expandedSpeciesId = expanded ? speciesId : null;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            municipalities = await MunicipalityRepository.GetAllMunicipalitiesAsync();
            await JS.InvokeVoidAsync("leafletInterop.initMap", DotNetObjectReference.Create(this));

            // Check if we need to show species locations
            if (SpeciesId.HasValue)
            {
                await LoadSpeciesLocations(SpeciesId.Value);
            }
        }
    }

    private async Task LoadSpeciesLocations(int speciesId)
    {
        viewingSpeciesLocations = await SpeciesRepository.GetSpeciesDetailAsync(speciesId);
        currentLocationIndex = 0;
        if (viewingSpeciesLocations?.Locations.Count > 0)
        {
            var locations = viewingSpeciesLocations.Locations.Select(l => new
            {
                latitude = l.Latitude,
                longitude = l.Longitude,
                radiusMeters = l.RadiusMeters,
                description = l.Description
            }).ToArray();

            await JS.InvokeVoidAsync("leafletInterop.showSpeciesLocations", viewingSpeciesLocations.CommonName, locations);

            // Focus on the first location
            await JS.InvokeVoidAsync("leafletInterop.focusOnLocation", 0);
        }
        StateHasChanged();
    }

    private async Task ClearSpeciesLocations()
    {
        await JS.InvokeVoidAsync("leafletInterop.clearSpeciesLocations");
        viewingSpeciesLocations = null;
        currentLocationIndex = 0;
        sheetOpen = false;
        NavigationManager.NavigateTo("/", replace: true);
    }

    private async Task FocusOnLocation(int index)
    {
        await JS.InvokeVoidAsync("leafletInterop.focusOnLocation", index);
    }

    private async Task FocusAllLocations()
    {
        await JS.InvokeVoidAsync("leafletInterop.focusAllLocations");
    }

    private async Task PreviousLocation()
    {
        if (currentLocationIndex > 0)
        {
            currentLocationIndex--;
            await FocusOnLocation(currentLocationIndex);
        }
    }

    private async Task NextLocation()
    {
        if (viewingSpeciesLocations != null && currentLocationIndex < viewingSpeciesLocations.Locations.Count - 1)
        {
            currentLocationIndex++;
            await FocusOnLocation(currentLocationIndex);
        }
    }

    [JSInvokable]
    public async Task OnMunicipalityClick(string geoJsonId, string name)
    {
        var municipality = municipalities?.FirstOrDefault(m => m.GeoJsonId == geoJsonId);

        showAllSpecies = false;
        showNearbySpecies = false;
        expandedSpeciesId = null;
        selectedMunicipality = municipality;
        clickedMunicipalityName = name;
        species = [];
        sheetOpen = false;
        sidebarOpen = true;

        // Clear nearby species search
        await JS.InvokeVoidAsync("leafletInterop.clearSearchRadius");

        // Reset filters when switching municipalities
        ClearAllFilters();
        currentSort = SortOption.NameAZ;

        StateHasChanged();

        // Small delay to allow DOM to render before triggering animation
        await Task.Delay(10);
        sheetOpen = true;
        StateHasChanged();

        await LoadMunicipalitySpeciesCommand.ExecuteAsync();
    }

    [JSInvokable]
    public void OnUserLocationFound(double latitude, double longitude)
    {
        userLatitude = latitude;
        userLongitude = longitude;
        StateHasChanged();
    }

    [RelayCommand]
    private async Task LoadMunicipalitySpecies()
    {
        if (selectedMunicipality != null)
        {
            species = await SpeciesRepository.GetSpeciesByMunicipalityAsync(selectedMunicipality.Id);
        }
    }

    [RelayCommand]
    private async Task LoadAllSpecies(CancellationToken cancellationToken)
    {
        showAllSpecies = true;
        selectedMunicipality = null;
        sheetOpen = false;
        sidebarOpen = true;
        StateHasChanged();

        await Task.Delay(10);
        sheetOpen = true;
        StateHasChanged();

        allSpecies = await SpeciesRepository.GetSpeciesAsync(new SpeciesParameters(PageSize: 500), cancellationToken);
    }

    private void ShowAllSpecies()
    {
        selectedMunicipality = null;
        clickedMunicipalityName = null;
        species = [];
        expandedSpeciesId = null;
    }

    private void CloseAllSpecies()
    {
        sheetOpen = false;
        sidebarOpen = false;
        allSpecies = [];
        showAllSpecies = false;
    }

    private void CloseSidebar()
    {
        sidebarOpen = false;
        selectedMunicipality = null;
        clickedMunicipalityName = null;
        showAllSpecies = false;
        species = [];
        allSpecies = [];
        expandedSpeciesId = null;
        ClearAllFilters();
    }

    private async Task CloseSheet()
    {
        sheetOpen = false;
        sidebarOpen = false;
        StateHasChanged();

        // Wait for close animation
        await Task.Delay(300);

        selectedMunicipality = null;
        clickedMunicipalityName = null;
        showAllSpecies = false;
        showNearbySpecies = false;
        species = [];
        allSpecies = [];
        nearbySpecies = [];
        expandedSpeciesId = null;
        ClearAllFilters();
        await JS.InvokeVoidAsync("leafletInterop.clearSearchRadius");
        StateHasChanged();
    }

    // Species Near Me methods
    private async Task OpenSpeciesNearMe()
    {
        if (userLatitude == null || userLongitude == null) return;

        showNearbySpecies = true;
        showAllSpecies = false;
        selectedMunicipality = null;
        clickedMunicipalityName = null;
        species = [];
        allSpecies = [];
        sheetOpen = false;
        sidebarOpen = true;

        StateHasChanged();

        await Task.Delay(10);
        sheetOpen = true;
        StateHasChanged();

        await SearchNearbySpecies();
    }

    private async Task SearchNearbySpecies()
    {
        if (userLatitude == null || userLongitude == null) return;

        isLoadingNearbySpecies = true;
        StateHasChanged();

        try
        {
            var radiusMeters = selectedRadiusKm * 1000.0;

            // Show search radius on map
            await JS.InvokeVoidAsync("leafletInterop.showSearchRadius", radiusMeters);

            // Query nearby species
            nearbySpecies = await SpeciesRepository.GetSpeciesNearbyAsync(
                userLatitude.Value,
                userLongitude.Value,
                radiusMeters);

            // Show nearby species on map
            var speciesLocations = nearbySpecies.Select(s => new
            {
                id = s.Id,
                commonName = s.CommonName,
                scientificName = s.ScientificName,
                distanceMeters = s.DistanceMeters,
                latitude = s.Latitude,
                longitude = s.Longitude,
                radiusMeters = s.RadiusMeters,
                locationDescription = s.LocationDescription
            }).ToArray();

            await JS.InvokeVoidAsync("leafletInterop.showNearbySpecies", speciesLocations);
        }
        finally
        {
            isLoadingNearbySpecies = false;
            StateHasChanged();
        }
    }

    private async Task OnRadiusChanged(int newRadius)
    {
        selectedRadiusKm = newRadius;
        await SearchNearbySpecies();
    }

    private async Task CloseSpeciesNearMe()
    {
        showNearbySpecies = false;
        nearbySpecies = [];
        sidebarOpen = false;
        sheetOpen = false;
        await JS.InvokeVoidAsync("leafletInterop.clearSearchRadius");
        StateHasChanged();
    }

    private async Task FocusOnNearbySpecies(int index)
    {
        await JS.InvokeVoidAsync("leafletInterop.focusOnNearbySpecies", index);
    }

    private string FormatDistance(double meters)
    {
        if (meters < 1000)
        {
            return $"{meters:N0}m";
        }
        return $"{meters / 1000:N1}km";
    }
}
