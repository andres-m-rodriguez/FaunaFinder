@inject IAppLocalizer L

<MudExpansionPanel Expanded="@IsExpanded"
                   ExpandedChanged="@OnExpandedChanged"
                   Class="mb-2">
    <TitleContent>
        <div class="d-flex flex-column">
            <MudText Typo="@TitleTypo" Color="Color.Primary" Style="font-weight: 600;">
                @L.GetLocalizedValue(Species.CommonName)
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1" Style="font-style: italic;">
                @Species.ScientificName
            </MudText>
        </div>
    </TitleContent>
    <ChildContent>
        <ConservationLinksList Links="@DisplayedLinks"
                               UseGrid="UseGridLayout"
                               ShowEmptyMessage="ShowEmptyMessage" />

        @if (Species.FwsLinks.Any() || (ShowViewDetails && OnViewDetails.HasDelegate))
        {
            <div class="d-flex align-center mt-3 gap-2">
                @if (HasMoreLinks)
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               OnClick="@ToggleShowAll">
                        @if (_showAllLinks)
                        {
                            @L["ShowLess"]
                        }
                        else
                        {
                            @L["LoadMore"]
                        }
                    </MudButton>
                }
                @if (ShowViewDetails && OnViewDetails.HasDelegate)
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Small"
                               EndIcon="@Icons.Material.Filled.OpenInNew"
                               OnClick="OnViewDetails">
                        @L["ViewDetails"]
                    </MudButton>
                }
            </div>
        }
    </ChildContent>
</MudExpansionPanel>

@code {
    private const int InitialLinksToShow = 3;
    private bool _showAllLinks;
    private string? _previousSpeciesName;

    [CascadingParameter(Name = "LanguageRefresh")]
    private int LanguageRefresh { get; set; }

    [Parameter, EditorRequired]
    public SpeciesForListDto Species { get; set; } = null!;

    [Parameter]
    public bool IsExpanded { get; set; }

    [Parameter]
    public EventCallback<bool> OnExpandedChanged { get; set; }

    [Parameter]
    public bool ShowViewDetails { get; set; }

    [Parameter]
    public EventCallback OnViewDetails { get; set; }

    [Parameter]
    public bool UseGridLayout { get; set; }

    [Parameter]
    public bool ShowEmptyMessage { get; set; }

    [Parameter]
    public Typo TitleTypo { get; set; } = Typo.subtitle2;

    private bool HasMoreLinks => Species.FwsLinks.Count() > InitialLinksToShow;

    private IEnumerable<FwsLinkDto> DisplayedLinks =>
        _showAllLinks ? Species.FwsLinks : Species.FwsLinks.Take(InitialLinksToShow);

    protected override void OnParametersSet()
    {
        // Reset "show all" when species changes or panel collapses
        if (Species.ScientificName != _previousSpeciesName || !IsExpanded)
        {
            _showAllLinks = false;
            _previousSpeciesName = Species.ScientificName;
        }
    }

    private void ToggleShowAll()
    {
        _showAllLinks = !_showAllLinks;
    }
}
