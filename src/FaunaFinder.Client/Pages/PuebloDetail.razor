@page "/pueblos/{Id:int}"
@using BlazingSingularity.Commands
@inject IMunicipalityHttpClient MunicipalityHttpClient
@inject ISpeciesHttpClient SpeciesHttpClient
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@(municipality?.Name ?? "Pueblo") - FaunaFinder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @* Back Navigation *@
    <MudButton Variant="Variant.Text"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.ArrowBack"
               OnClick="NavigateBack"
               Class="mb-4">
        @L["Back"]
    </MudButton>

    @* Municipality Header Section *@
    @if (isLoadingMunicipality)
    {
        <MudPaper Elevation="2" Class="pa-4 mb-6">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" Width="50%" Class="mb-3 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="24px" Width="30%" Class="rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
        </MudPaper>
    }
    else if (municipality == null)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
            @L["Error_MunicipalityNotFound"]
        </MudAlert>
    }
    else
    {
        <MudPaper Elevation="2" Class="pa-4 mb-6">
            <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@municipality.Name</MudText>
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Medium" Color="Color.Secondary" Class="mr-2" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">
                    @municipality.SpeciesCount @L["Pueblos_Species"]
                </MudText>
            </div>
        </MudPaper>
    }

    @* Species List Section - only show if municipality loaded *@
    @if (municipality != null || isLoadingMunicipality)
    {
        <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true" Class="mb-4">@L["PuebloDetail_SpeciesInMunicipality"]</MudText>

        @if (isLoadingSpecies)
        {
            @for (int i = 0; i < 6; i++)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-3 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
            }
        }
        else if (species.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
                @L["PuebloDetail_NoSpeciesData"]
            </MudAlert>
        }
        else
        {
            <SpeciesFilterToolbar SearchText="@searchText"
                                   SearchTextChanged="OnSearchTextChanged"
                                   SelectedNrcsPractice="@selectedNrcsPractice"
                                   SelectedNrcsPracticeChanged="OnNrcsPracticeChanged"
                                   SelectedFwsAction="@selectedFwsAction"
                                   SelectedFwsActionChanged="OnFwsActionChanged"
                                   AvailableNrcsPractices="@AvailableNrcsPractices"
                                   AvailableFwsActions="@AvailableFwsActions"
                                   FilteredCount="@FilteredSpecies.Count"
                                   TotalCount="@species.Count"
                                   SearchPlaceholder="@L["Species_SearchPlaceholder"]"
                                   FilteredCountFormat="@L["Filter_ShowingFiltered"]" />

            @if (FilteredSpecies.Count == 0)
            {
                <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-4">
                    @L["Filter_NoMatches"]
                </MudAlert>
            }
            else
            {
                <MudExpansionPanels MultiExpansion="false" Elevation="1">
                    @foreach (var s in FilteredSpecies)
                    {
                        <SpeciesExpansionPanel Species="s"
                                               IsExpanded="@(expandedSpeciesId == s.Id)"
                                               OnExpandedChanged="@((bool expanded) => ToggleSpecies(s.Id, expanded))"
                                               ShowViewDetails="true"
                                               OnViewDetails="@(() => NavigateToSpecies(s.Id))"
                                               UseGridLayout="true"
                                               ShowEmptyMessage="true"
                                               TitleTypo="Typo.subtitle1" />
                    }
                </MudExpansionPanels>
            }
        }
    }
</MudContainer>

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private MunicipalityForDetailDto? municipality;
    private IReadOnlyList<SpeciesForListDto> species = [];
    private int? expandedSpeciesId;

    private bool isLoadingMunicipality = true;
    private bool isLoadingSpecies = true;

    // Filter state
    private string searchText = string.Empty;
    private string? selectedNrcsPractice;
    private string? selectedFwsAction;

    private IEnumerable<string> AvailableNrcsPractices => species
        .SelectMany(s => s.FwsLinks)
        .Select(l => l.NrcsPractice.Code)
        .Distinct()
        .OrderBy(c => c);

    private IEnumerable<string> AvailableFwsActions => species
        .SelectMany(s => s.FwsLinks)
        .Select(l => l.FwsAction.Code)
        .Distinct()
        .OrderBy(c => c);

    private IReadOnlyList<SpeciesForListDto> FilteredSpecies
    {
        get
        {
            if (species.Count == 0) return [];

            var filtered = species.AsEnumerable();

            // Apply text search filter (common name, scientific name)
            if (!string.IsNullOrWhiteSpace(searchText))
            {
                filtered = filtered.Where(s =>
                    L.GetLocalizedValue(s.CommonName).Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    s.ScientificName.Contains(searchText, StringComparison.OrdinalIgnoreCase));
            }

            // Apply NRCS Practice filter
            if (!string.IsNullOrEmpty(selectedNrcsPractice))
            {
                filtered = filtered.Where(s => s.FwsLinks.Any(l => l.NrcsPractice.Code == selectedNrcsPractice));
            }

            // Apply FWS Action filter
            if (!string.IsNullOrEmpty(selectedFwsAction))
            {
                filtered = filtered.Where(s => s.FwsLinks.Any(l => l.FwsAction.Code == selectedFwsAction));
            }

            return filtered.ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Load both in parallel
        var municipalityTask = LoadMunicipalityAsync();
        var speciesTask = LoadSpeciesAsync();

        await Task.WhenAll(municipalityTask, speciesTask);
    }

    private async Task LoadMunicipalityAsync()
    {
        isLoadingMunicipality = true;
        municipality = await MunicipalityHttpClient.GetMunicipalityDetailAsync(Id);
        isLoadingMunicipality = false;
        StateHasChanged();
    }

    private async Task LoadSpeciesAsync()
    {
        isLoadingSpecies = true;
        species = await SpeciesHttpClient.GetSpeciesByMunicipalityAsync(Id);
        isLoadingSpecies = false;
        StateHasChanged();
    }

    private void OnSearchTextChanged(string value)
    {
        searchText = value;
    }

    private void OnNrcsPracticeChanged(string? value)
    {
        selectedNrcsPractice = value;
    }

    private void OnFwsActionChanged(string? value)
    {
        selectedFwsAction = value;
    }

    private void ToggleSpecies(int speciesId, bool expanded)
    {
        expandedSpeciesId = expanded ? speciesId : null;
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo(string.IsNullOrEmpty(ReturnUrl) ? "/pueblos" : ReturnUrl);
    }

    private void NavigateToSpecies(int speciesId)
    {
        NavigationManager.NavigateTo($"/species/{speciesId}?returnUrl=/pueblos/{Id}");
    }
}
