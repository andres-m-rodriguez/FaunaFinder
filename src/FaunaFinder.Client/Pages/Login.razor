@page "/login"
@using FaunaFinder.Client.Services.Auth
@inject CookieAuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@L["Login_Title"] - FaunaFinder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-16">
    <MudPaper Elevation="4" Class="pa-8">
        <div class="d-flex flex-column align-center">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Primary" Class="mb-4" />

            <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true" Align="Align.Center">
                @L["Login_Title"]
            </MudText>

            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6" Align="Align.Center">
                @L["Login_Description"]
            </MudText>

            <AuthorizeView>
                <Authorized Context="authContext">
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        @L["Login_AlreadyLoggedIn", authContext.User.Identity?.Name ?? "User"]
                    </MudAlert>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Home"
                               OnClick="@(() => NavigationManager.NavigateTo("/"))">
                        @L["Login_GoToHome"]
                    </MudButton>
                </Authorized>
                <NotAuthorized Context="_">
                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true">
                            @_error
                        </MudAlert>
                    }

                    <EditForm Model="_model" OnValidSubmit="HandleLogin" style="width: 100%;">
                        <DataAnnotationsValidator />

                        <MudTextField @bind-Value="_model.Email"
                                      Label="@L["Login_Email"]"
                                      InputType="InputType.Email"
                                      Variant="Variant.Outlined"
                                      Class="mb-4"
                                      Required="true"
                                      RequiredError="@L["Login_EmailRequired"]" />

                        <MudTextField @bind-Value="_model.Password"
                                      Label="@L["Login_Password"]"
                                      InputType="InputType.Password"
                                      Variant="Variant.Outlined"
                                      Class="mb-4"
                                      Required="true"
                                      RequiredError="@L["Login_PasswordRequired"]" />

                        <MudCheckBox @bind-Value="_model.RememberMe"
                                     Label="@L["Login_RememberMe"]"
                                     Class="mb-4" />

                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   Disabled="_isLoading"
                                   Class="mb-4">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            @L["Login_SignIn"]
                        </MudButton>
                    </EditForm>

                    <MudText Typo="Typo.body2" Align="Align.Center">
                        @L["Login_NoAccount"]
                        <MudLink Href="/register">@L["Login_CreateAccount"]</MudLink>
                    </MudText>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </MudPaper>
</MudContainer>

@code {
    private LoginModel _model = new();
    private bool _isLoading;
    private string? _error;

    private async Task HandleLogin()
    {
        _isLoading = true;
        _error = null;
        StateHasChanged();

        var result = await AuthStateProvider.LoginAsync(_model.Email, _model.Password, _model.RememberMe);

        result.Switch(
            user => NavigationManager.NavigateTo("/"),
            invalidCredentials => _error = invalidCredentials.Message,
            accountLocked => _error = accountLocked.Message,
            accountNotApproved => _error = L["Login_PendingApproval"],
            validationError => _error = validationError.Message,
            unexpected => _error = unexpected.Message);

        _isLoading = false;
    }

    private class LoginModel
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public bool RememberMe { get; set; }
    }
}
