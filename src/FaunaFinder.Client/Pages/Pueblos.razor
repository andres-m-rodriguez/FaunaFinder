@page "/pueblos"
@inject IMunicipalityService MunicipalityService
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@L["PageTitle_Pueblos"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@L["Pueblos_Title"]</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        @L["Pueblos_Description"]
    </MudText>

    <MudTextField @bind-Value="searchTerm"
                  Placeholder="@L["Pueblos_SearchPlaceholder"]"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="OnSearchChanged"
                  Class="mb-4" />

    @* Municipalities Grid *@
    @if (isLoadingMunicipalities)
    {
        <MudGrid Spacing="3">
            @for (int i = 0; i < 8; i++)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="80px" Class="rounded" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (municipalities.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
            @L["Pueblos_NoResults"]
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var municipality in municipalities)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="2" Class="municipality-card" Style="cursor: pointer;" @onclick="() => NavigateToDetail(municipality.Id)">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary">@municipality.Name</MudText>
                            <div class="d-flex align-center mt-2">
                                <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Small" Color="Color.Secondary" Class="mr-2" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @municipality.SpeciesCount @L["Pueblos_Species"]
                                </MudText>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    @* Pagination - show skeleton while count is loading *@
    @if (municipalities.Count > 0 || isLoadingMunicipalities)
    {
        <div class="d-flex justify-center mt-6">
            @if (isLoadingCount)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" Width="300px" Class="rounded" />
            }
            else
            {
                <MudPagination Count="@totalPages"
                              Selected="@(currentPage + 1)"
                              SelectedChanged="OnPageChanged"
                              Color="Color.Primary"
                              Variant="Variant.Filled"
                              ShowFirstButton="true"
                              ShowLastButton="true" />
            }
        </div>

        <div class="d-flex justify-center mt-2">
            @if (isLoadingCount)
            {
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="20px" Width="200px" Class="rounded" />
            }
            else
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                    @L["Pueblos_Showing", (currentPage * pageSize) + 1, Math.Min((currentPage + 1) * pageSize, totalCount), totalCount]
                </MudText>
            }
        </div>
    }
</MudContainer>

@code {
    private IReadOnlyList<MunicipalityCardDto> municipalities = [];
    private string searchTerm = string.Empty;
    private int currentPage = 0;
    private int pageSize = 12;
    private int totalCount = 0;
    private int totalPages = 0;

    private bool isLoadingMunicipalities = true;
    private bool isLoadingCount = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoadingMunicipalities = true;
        isLoadingCount = true;

        var municipalitiesTask = LoadMunicipalitiesAsync();
        var countTask = LoadCountAsync();

        await Task.WhenAll(municipalitiesTask, countTask);
    }

    private async Task LoadMunicipalitiesAsync()
    {
        var parameters = new MunicipalityParameters(
            PageSize: pageSize,
            Page: currentPage,
            Search: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
        );

        municipalities = await MunicipalityService.GetMunicipalitiesWithSpeciesCountAsync(parameters);
        isLoadingMunicipalities = false;
        StateHasChanged();
    }

    private async Task LoadCountAsync()
    {
        totalCount = await MunicipalityService.GetTotalMunicipalitiesCountAsync(
            string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
        );
        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
        isLoadingCount = false;
        StateHasChanged();
    }

    private async Task OnSearchChanged()
    {
        currentPage = 0;
        await LoadDataAsync();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page - 1;
        await LoadDataAsync();
    }

    private void NavigateToDetail(int municipalityId)
    {
        NavigationManager.NavigateTo($"/pueblos/{municipalityId}?returnUrl=/pueblos");
    }
}
