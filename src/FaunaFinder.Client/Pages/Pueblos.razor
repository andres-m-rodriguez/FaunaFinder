@page "/pueblos"
@using BlazingSingularity.Commands
@inject IMunicipalityService MunicipalityService
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@L["PageTitle_Pueblos"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@L["Pueblos_Title"]</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        @L["Pueblos_Description"]
    </MudText>

    <MudTextField @bind-Value="searchTerm"
                  Placeholder="@L["Pueblos_SearchPlaceholder"]"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="OnSearchChanged"
                  Class="mb-4" />

    @if (LoadMunicipalitiesCommand.IsLoading)
    {
        @for (int i = 0; i < 8; i++)
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-3 rounded" />
        }
    }
    else if (municipalities.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
            @L["Pueblos_NoResults"]
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var municipality in municipalities)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="2" Class="municipality-card" Style="cursor: pointer;" @onclick="() => NavigateToDetail(municipality.Id)">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary">@municipality.Name</MudText>
                            <div class="d-flex align-center mt-2">
                                <MudIcon Icon="@Icons.Material.Filled.Pets" Size="Size.Small" Color="Color.Secondary" Class="mr-2" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @municipality.SpeciesCount @L["Pueblos_Species"]
                                </MudText>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <div class="d-flex justify-center mt-6">
            <MudPagination Count="@totalPages"
                          Selected="@(currentPage + 1)"
                          SelectedChanged="OnPageChanged"
                          Color="Color.Primary"
                          Variant="Variant.Filled"
                          ShowFirstButton="true"
                          ShowLastButton="true" />
        </div>

        <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center" Class="mt-2">
            @L["Pueblos_Showing", (currentPage * pageSize) + 1, Math.Min((currentPage + 1) * pageSize, totalCount), totalCount]
        </MudText>
    }
</MudContainer>

@code {
    private IReadOnlyList<MunicipalityCardDto> municipalities = [];
    private string searchTerm = string.Empty;
    private int currentPage = 0;
    private int pageSize = 12;
    private int totalCount = 0;
    private int totalPages = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadMunicipalitiesCommand.ExecuteAsync();
    }

    [RelayCommand]
    private async Task LoadMunicipalities()
    {
        var parameters = new MunicipalityParameters(
            PageSize: pageSize,
            Page: currentPage,
            Search: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
        );

        municipalities = await MunicipalityService.GetMunicipalitiesWithSpeciesCountAsync(parameters);
        totalCount = await MunicipalityService.GetTotalMunicipalitiesCountAsync(
            string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm
        );
        totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    }

    private async Task OnSearchChanged()
    {
        currentPage = 0;
        await LoadMunicipalitiesCommand.ExecuteAsync();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page - 1;
        await LoadMunicipalitiesCommand.ExecuteAsync();
    }

    private void NavigateToDetail(int municipalityId)
    {
        NavigationManager.NavigateTo($"/pueblos/{municipalityId}?returnUrl=/pueblos");
    }
}
