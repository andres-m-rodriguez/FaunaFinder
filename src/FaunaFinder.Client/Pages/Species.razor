@page "/species"
@implements IDisposable
@inject ISpeciesService SpeciesService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject IAppLocalizer L

<PageTitle>@L["PageTitle_Species"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@L["Species_Title"]</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        @L["Species_Description"]
    </MudText>

    <MudTextField @bind-Value="searchTerm"
                  Placeholder="@L["Species_SearchPlaceholder"]"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Variant="Variant.Outlined"
                  Immediate="true"
                  DebounceInterval="300"
                  OnDebounceIntervalElapsed="OnSearchChanged"
                  Class="mb-4" />

    @* Species Grid *@
    @if (isInitialLoading)
    {
        <MudGrid Spacing="3">
            @for (int i = 0; i < 20; i++)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (species.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
            @L["Species_NoResults"]
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var s in species)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <SpeciesCard CommonName="@s.CommonName"
                                 ScientificName="@s.ScientificName"
                                 MunicipalityCount="@s.MunicipalityNames.Count"
                                 OnClick="() => NavigateToSpecies(s.Id)" />
                </MudItem>
            }
        </MudGrid>
    }

    @* Infinite scroll trigger / Load more button *@
    @if (hasMore)
    {
        <div @ref="loadMoreTrigger" class="d-flex justify-center py-4">
            @if (isLoadingMore)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Small" />
            }
            else
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="LoadMore">
                    @L["LoadMore"]
                </MudButton>
            }
        </div>
    }
</MudContainer>

@code {
    [CascadingParameter(Name = "LanguageRefresh")]
    private int LanguageRefresh { get; set; }

    private List<SpeciesForSearchDto> species = new();
    private string searchTerm = string.Empty;
    private string? nextCursor;
    private bool hasMore = true;
    private bool isInitialLoading = true;
    private bool isLoadingMore = false;
    private ElementReference loadMoreTrigger;
    private DotNetObjectReference<Species>? dotNetRef;
    private bool isObserverInitialized = false;

    private const int PageSize = 20;

    protected override async Task OnInitializedAsync()
    {
        await LoadPageAsync();
        isInitialLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && hasMore && !isObserverInitialized)
        {
            await InitializeObserverAsync();
        }
    }

    private async Task InitializeObserverAsync()
    {
        dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("infiniteScrollInterop.observe", loadMoreTrigger, dotNetRef);
        isObserverInitialized = true;
    }

    [JSInvokable]
    public async Task LoadMore()
    {
        if (isLoadingMore || !hasMore) return;
        await LoadPageAsync();
    }

    private async Task LoadPageAsync()
    {
        isLoadingMore = true;
        StateHasChanged();

        var request = new CursorPageRequest(nextCursor, PageSize, string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm);
        var page = await SpeciesService.GetSpeciesCursorPageAsync(request);

        species.AddRange(page.Items);
        nextCursor = page.NextCursor;
        hasMore = page.HasMore;

        isLoadingMore = false;
        StateHasChanged();
    }

    private async Task OnSearchChanged()
    {
        // Reset state for new search
        species.Clear();
        nextCursor = null;
        hasMore = true;
        isInitialLoading = true;
        isObserverInitialized = false;

        // Disconnect existing observer
        await JS.InvokeVoidAsync("infiniteScrollInterop.disconnect");

        await LoadPageAsync();
        isInitialLoading = false;

        // Re-initialize observer if there are more results
        if (hasMore)
        {
            StateHasChanged();
            await Task.Yield(); // Allow render to complete
            await InitializeObserverAsync();
        }
    }

    private void NavigateToSpecies(int speciesId)
    {
        NavigationManager.NavigateTo($"/species/{speciesId}?returnUrl=/species");
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
        _ = JS.InvokeVoidAsync("infiniteScrollInterop.disconnect");
    }
}
