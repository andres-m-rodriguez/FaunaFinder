@page "/species/{Id:int}"
@using BlazingSingularity.Commands
@inject ISpeciesHttpClient SpeciesHttpClient
@inject NavigationManager NavigationManager
@inject IAppLocalizer L

<PageTitle>@(species != null ? L.GetLocalizedValue(species.CommonName) : L["Nav_Species"]) - FaunaFinder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @* Back Navigation *@
    <MudButton Variant="Variant.Text"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.ArrowBack"
               OnClick="NavigateBack"
               Class="mb-4">
        @L["Back"]
    </MudButton>

    @if (LoadDataCommand.IsLoading)
    {
        <MudPaper Elevation="2" Class="pa-4 mb-6">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="40px" Class="mb-3 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="24px" Width="60%" Class="mb-3 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="20px" Width="40%" Class="mb-3 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="36px" Width="150px" Class="rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
        </MudPaper>

        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="32px" Width="200px" Class="mb-4 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
        <MudGrid Spacing="3" Class="mb-6">
            @for (int i = 0; i < 4; i++)
            {
                <MudItem xs="6" sm="4" md="3">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="50px" Class="rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
                </MudItem>
            }
        </MudGrid>

        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="32px" Width="250px" Class="mb-4 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
        @for (int i = 0; i < 2; i++)
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" Class="mb-3 rounded" Style="border: 1px solid rgba(255,255,255,0.1);" />
        }
    }
    else if (species == null)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
            @L["Error_SpeciesNotFound"]
        </MudAlert>
    }
    else
    {
        @* Species Header *@
        <MudPaper Elevation="2" Class="pa-4 mb-6">
            <MudGrid>
                @if (species.HasProfileImage)
                {
                    <MudItem xs="12" sm="4" md="3">
                        <MudImage Src="@GetProfileImageUrl()"
                                  Alt="@L.GetLocalizedValue(species.CommonName)"
                                  ObjectFit="ObjectFit.Cover"
                                  Class="rounded-lg species-image"
                                  Style="width: 100%; max-height: 200px;" />
                    </MudItem>
                }
                <MudItem xs="12" sm="@(species.HasProfileImage ? 8 : 12)" md="@(species.HasProfileImage ? 9 : 12)">
                    <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true">@L.GetLocalizedValue(species.CommonName)</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Secondary" Class="font-italic">@species.ScientificName</MudText>
                    <div class="d-flex align-center mt-3">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Medium" Color="Color.Secondary" Class="mr-2" />
                        <MudText Typo="Typo.body1" Color="Color.Secondary">
                            @L["SpeciesDetail_FoundIn", species.Municipalities.Count, species.Municipalities.Count == 1 ? L["Species_Municipality"] : L["Species_Municipalities"]]
                        </MudText>
                    </div>
                    @if (species.Locations.Count > 0)
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Map"
                                   OnClick="ViewLocations"
                                   Class="mt-4">
                            @L["SpeciesDetail_ViewLocations"]
                        </MudButton>
                    }
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Municipalities Section *@
        <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true" Class="mb-4">@L["SpeciesDetail_MunicipalitiesTitle"]</MudText>

        @if (species.Municipalities.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-6">
                @L["SpeciesDetail_NoMunicipalityData"]
            </MudAlert>
        }
        else
        {
            <MudGrid Spacing="3" Class="mb-6">
                @foreach (var municipality in species.Municipalities)
                {
                    <MudItem xs="6" sm="4" md="3">
                        <MunicipalityCard Name="@municipality.Name"
                                          Compact="true"
                                          OnClick="() => NavigateToMunicipality(municipality.Id)" />
                    </MudItem>
                }
            </MudGrid>
        }

        @* Conservation Links Section *@
        <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true" Class="mb-4">@L["SpeciesDetail_ConservationLinksTitle"]</MudText>

        @if (species.FwsLinks.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Class="mb-4">
                @L["SpeciesDetail_NoConservationLinks"]
            </MudAlert>
        }
        else
        {
            @* Search and Filter Controls *@
            <MudPaper Elevation="1" Class="pa-3 mb-4">
                <MudGrid Spacing="2">
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="searchText"
                                      Placeholder="@L["Filter_SearchLinks"]"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Immediate="true"
                                      Clearable="true" />
                    </MudItem>
                    <MudItem xs="12" md="6" Class="d-flex align-center gap-2 flex-wrap">
                        <MudSelect T="string"
                                   Value="selectedNrcsPractice"
                                   ValueChanged="OnNrcsPracticeChanged"
                                   Label="@L["Filter_NrcsPractices"]"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Dense="true"
                                   Clearable="true"
                                   Style="min-width: 150px;">
                            @foreach (var practice in AvailableNrcsPractices)
                            {
                                <MudSelectItem Value="@practice">@practice</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect T="string"
                                   Value="selectedFwsAction"
                                   ValueChanged="OnFwsActionChanged"
                                   Label="@L["Filter_FwsActions"]"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Dense="true"
                                   Clearable="true"
                                   Style="min-width: 150px;">
                            @foreach (var action in AvailableFwsActions)
                            {
                                <MudSelectItem Value="@action">@action</MudSelectItem>
                            }
                        </MudSelect>
                        @if (HasActiveFilters)
                        {
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Clear"
                                       OnClick="ClearAllFilters">
                                @L["Filter_ClearAll"]
                            </MudButton>
                        }
                    </MudItem>
                </MudGrid>

                @* Active Filter Chips *@
                @if (HasActiveFilters)
                {
                    <div class="d-flex flex-wrap gap-1 mt-3">
                        @if (!string.IsNullOrWhiteSpace(searchText))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" OnClose="ClearSearchText">
                                "@searchText"
                            </MudChip>
                        }
                        @if (!string.IsNullOrEmpty(selectedNrcsPractice))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" OnClose="ClearNrcsPractice">
                                NRCS @selectedNrcsPractice
                            </MudChip>
                        }
                        @if (!string.IsNullOrEmpty(selectedFwsAction))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" OnClose="ClearFwsAction">
                                FWS @selectedFwsAction
                            </MudChip>
                        }
                    </div>
                }

                @* Filtered Count *@
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                    @string.Format(L["Filter_ShowingFilteredLinks"], FilteredLinks.Count, species.FwsLinks.Count)
                </MudText>
            </MudPaper>

            @if (FilteredLinks.Count == 0)
            {
                <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Class="mb-4">
                    @L["Filter_NoMatchesLinks"]
                </MudAlert>
            }
            else
            {
                <MudGrid Spacing="3">
                    @foreach (var link in FilteredLinks)
                    {
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-4">
                                <div class="d-flex flex-wrap align-start gap-2 mb-2">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                        NRCS @link.NrcsPractice.Code
                                    </MudChip>
                                    <MudText Typo="Typo.body1">@link.NrcsPractice.Name</MudText>
                                </div>
                                <div class="d-flex flex-wrap align-start gap-2 mb-2">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">
                                        FWS @link.FwsAction.Code
                                    </MudChip>
                                    <MudText Typo="Typo.body1">@link.FwsAction.Name</MudText>
                                </div>
                                @if (!string.IsNullOrEmpty(link.Justification))
                                {
                                    <MudDivider Class="my-3" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @link.Justification
                                    </MudText>
                                }
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            }
        }
    }
</MudContainer>

@code {
    [CascadingParameter(Name = "LanguageRefresh")]
    private int LanguageRefresh { get; set; }

    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private SpeciesForDetailDto? species;

    // Filter state
    private string searchText = string.Empty;
    private string? selectedNrcsPractice;
    private string? selectedFwsAction;

    private bool HasActiveFilters => !string.IsNullOrWhiteSpace(searchText) ||
                                      !string.IsNullOrEmpty(selectedNrcsPractice) ||
                                      !string.IsNullOrEmpty(selectedFwsAction);

    private IEnumerable<string> AvailableNrcsPractices => species?.FwsLinks
        .Select(l => l.NrcsPractice.Code)
        .Distinct()
        .OrderBy(c => c) ?? Enumerable.Empty<string>();

    private IEnumerable<string> AvailableFwsActions => species?.FwsLinks
        .Select(l => l.FwsAction.Code)
        .Distinct()
        .OrderBy(c => c) ?? Enumerable.Empty<string>();

    private IReadOnlyList<FwsLinkDto> FilteredLinks
    {
        get
        {
            if (species == null) return [];

            var filtered = species.FwsLinks.AsEnumerable();

            // Apply text search filter
            if (!string.IsNullOrWhiteSpace(searchText))
            {
                var searchLower = searchText.ToLowerInvariant();
                filtered = filtered.Where(l =>
                    l.NrcsPractice.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    l.NrcsPractice.Code.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    l.FwsAction.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    l.FwsAction.Code.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    (l.Justification?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            // Apply NRCS Practice filter
            if (!string.IsNullOrEmpty(selectedNrcsPractice))
            {
                filtered = filtered.Where(l => l.NrcsPractice.Code == selectedNrcsPractice);
            }

            // Apply FWS Action filter
            if (!string.IsNullOrEmpty(selectedFwsAction))
            {
                filtered = filtered.Where(l => l.FwsAction.Code == selectedFwsAction);
            }

            return filtered.ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataCommand.ExecuteAsync();
    }

    [RelayCommand]
    private async Task LoadData()
    {
        species = await SpeciesHttpClient.GetSpeciesDetailAsync(Id);
    }

    private void OnNrcsPracticeChanged(string? value)
    {
        selectedNrcsPractice = value;
    }

    private void OnFwsActionChanged(string? value)
    {
        selectedFwsAction = value;
    }

    private void ClearSearchText()
    {
        searchText = string.Empty;
    }

    private void ClearNrcsPractice()
    {
        selectedNrcsPractice = null;
    }

    private void ClearFwsAction()
    {
        selectedFwsAction = null;
    }

    private void ClearAllFilters()
    {
        searchText = string.Empty;
        selectedNrcsPractice = null;
        selectedFwsAction = null;
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo(string.IsNullOrEmpty(ReturnUrl) ? "/species" : ReturnUrl);
    }

    private void NavigateToMunicipality(int municipalityId)
    {
        NavigationManager.NavigateTo($"/pueblos/{municipalityId}?returnUrl=/species/{Id}");
    }

    private void ViewLocations()
    {
        NavigationManager.NavigateTo($"/?speciesId={Id}");
    }

    private string GetProfileImageUrl()
    {
        return species != null ? $"api/species/{species.Id}/image" : string.Empty;
    }
}
